namespace = th_leader_sp
@skill_producer_t1 = 10
@skill_producer_t2 = 20
@skill_producer_t3 = 40
@skill_support_t1 = 0.1
@skill_support_t2 = 0.2

# 绀珠之药
country_event = {
    id = th_leader_sp.100
    hide_window = yes
    is_triggered_only = yes
    trigger = { any_owned_leader = { has_leader_flag = spth_auto_clear_negative_traits } }
    immediate = {
        every_owned_leader = {
            limit = { has_leader_flag = spth_auto_clear_negative_traits }
            if = {
                limit = { NOT = { has_trait = spth_auto_clear_negative_traits } }
                remove_leader_flag = spth_auto_clear_negative_traits
                remove_leader_flag = immune_to_negative_traits
            } else_if = {
                limit = { num_leader_traits = { negative = yes value > 0 } }
                if = {
                    limit = {
                        prev = {
                            resource_stockpile_compare = { resource = sr_lingli value >= 120 }
                            resource_stockpile_compare = { resource = sr_fuka value >= 60 }
                        }
                    }
                    prev = { add_resource = { sr_lingli = -120 sr_fuka = -60 } }
                    remove_all_negative_traits = yes
                }
            }
        }
    }
}

# 拥戴 俘获陆军 attacker
# 开片了
planet_event = {
    id = th_leader_sp.900
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        # 需要延迟一天检测
        planet_event = { id = th_leader_sp.901 days = 1 }
    }
}

# 实际检测
planet_event = {
    id = th_leader_sp.901
    hide_window = yes
    is_triggered_only = yes

    trigger = {
        any_ground_combat_attacker = {
            exists = leader
            leader = {
                OR = {
                    has_trait = leader_trait_th_skill_support_2
                    has_trait = leader_trait_th_skill_support_3
                }
            }
        }
    }

    immediate = {
        set_variable = { which = TH_planet_defender_count value = 0 }
        every_ground_combat_defender = {
            root = {
                change_variable = { which = TH_planet_defender_count value = 1 }
            }
        }
    }
}

# 防御方寄了
# FromFrom = planet
country_event = {
    id = th_leader_sp.902
    picture = GFX_evt_th_card_leader
    title = th_leader_sp.902
    desc = th_leader_sp.902_desc
    is_triggered_only = yes
    trigger = {
        fromfrom = {
            planet = {
                has_ground_combat = yes
            }
            any_ground_combat_attacker = {
                exists = leader
                leader = {
                    OR = {
                        has_trait = leader_trait_th_skill_support_2
                        has_trait = leader_trait_th_skill_support_3
                    }
                }
            }
        }
    }

    immediate = {
        fromfrom = {
            random_ground_combat_attacker = {
                limit = {
                    exists = leader
                    leader = {
                        OR = {
                            has_trait = leader_trait_th_skill_support_2
                            has_trait = leader_trait_th_skill_support_3
                        }
                    }
                }

                if = {
                    limit = { leader = { has_trait = leader_trait_th_skill_support_2 } }
                    fromfrom = {
                        set_planet_flag = TH_skill_support_t1
                    }
                } else = {
                    fromfrom = {
                        set_planet_flag = TH_skill_support_t2
                    }
                }
            }
            if = {
                limit = {
                    fromfrom = { has_planet_flag = TH_skill_support_t1 }
                }
                TH_capture_defender_army = { mul = @skill_support_t1 OWNER = root TYPE = danmaku_army TARGET = fromfrom }
                remove_planet_flag = TH_skill_support_t1
            } else = {
                TH_capture_defender_army = { mul = @skill_support_t2 OWNER = root TYPE = danmaku_army TARGET = fromfrom }
                remove_planet_flag = TH_skill_support_t2
            }
            clear_variable = TH_planet_defender_count
            clear_variable = TH_capture_mul
        }
    }
    option = {
        name = GOOD
    }
}

# 敌后大生产 月度刷新
country_event = {
    id = th_leader_sp.1000
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        any_owned_leader = {
            leader_class = commander
            OR = {
                has_trait = leader_trait_th_skill_producer
                has_trait = leader_trait_th_skill_producer_2
                has_trait = leader_trait_th_skill_producer_3
            }
        }
    }
    immediate = {
        every_owned_fleet = {
            limit = {
                any_owned_ship = {
                    is_ship_class = shipclass_transport
                }
                exists = leader
                leader = {
                    leader_class = commander
                    OR = {
                        has_trait = leader_trait_th_skill_producer
                        has_trait = leader_trait_th_skill_producer_2
                        has_trait = leader_trait_th_skill_producer_3
                    }
                }
            }

            set_variable = { which = TH_leader_army_count value = trigger:num_ships }
            leader = {
                set_variable = { which = TH_leader_produce_factor value = prev.TH_leader_army_count }
                if = {
                    limit = { has_trait = leader_trait_th_skill_producer }
                    multiply_variable = { which = TH_leader_produce_factor value = @skill_producer_t1 }
                }
                else_if = {
                    limit = { has_trait = leader_trait_th_skill_producer_2 }
                    multiply_variable = { which = TH_leader_produce_factor value = @skill_producer_t2 }
                }
                else = {
                    multiply_variable = { which = TH_leader_produce_factor value = @skill_producer_t3 }
                }
            }
            root = {
                add_resource = { consumer_goods = 1 multiplier = prev.leader.TH_leader_produce_factor }
                add_resource = { food = 1 multiplier = prev.leader.TH_leader_produce_factor }
            }
            clear_variable = TH_leader_army_count
        }
    }
}