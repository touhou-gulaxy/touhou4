namespace = Th_dynamic_battle_vict
@last_the_world_t1 = 6
@last_the_world_t2 = 12
@last_the_world_t3 = 20
@last_satori_eye = 15
@last_koishi_eye = 15
@interval_the_world_first = 2
@interval_the_world_final = 3
@interval_satori_eye = 3
@interval_koishi_eye = 3

#######################################################
####################### 舰船动修 #######################
#######################################################
# Sakuya
ship_event = {
    id = Th_dynamic_battle_vict.1
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        has_ship_flag = TH_sakuya_the_world_dynamic_vict
    }
    immediate = {
        sakuya_the_world_dynamic = { interval = @interval_the_world_first }
    }
}

# Satori Victim
ship_event = {
    id = Th_dynamic_battle_vict.2
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        has_ship_flag = TH_satori_dynamic_vict
    }
    immediate = {
        satori_dynamic_battle = { interval = @interval_satori_eye }
    }
}

# Satori Boost
ship_event = {
    id = Th_dynamic_battle_vict.3
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        has_ship_flag = TH_satori_dynamic_boost
    }
    immediate = {
        satori_dynamic_boost = { interval = @interval_satori_eye }
    }
}

# Koishi Victim
ship_event = {
    id = Th_dynamic_battle_vict.4
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        has_ship_flag = TH_koishi_dynamic_vict
    }
    immediate = {
        koishi_dynamic_battle = { interval = @interval_koishi_eye }
    }
}

# Koishi Boost
ship_event = {
    id = Th_dynamic_battle_vict.5
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        has_ship_flag = TH_koishi_dynamic_boost
    }
    immediate = {
        koishi_dynamic_boost = { interval = @interval_koishi_eye }
    }
}

# yukari kamikakushi_0
# fleet event
fleet_event = {
    id = Th_dynamic_battle_vict.6
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        has_fleet_flag = spth_debuff_yukari_kamikakushi_0
    }
    immediate = {
        if = {
            limit = { is_in_combat = yes }

            set_variable = { which = yukari_kamikakushi_ship_counter value = 0 }
            random_list = {
                10 = {
                    every_owned_ship = {
                        set_timed_ship_flag = {
                            flag = spth_t0_yukari_kamikakushi_0
                            days = 7
                        }
                        ship_event = { id = Th_dynamic_battle_vict.7 }
                        ship_event = { id = Th_dynamic_battle_vict.10 days = 8 }
                    }
                }
                40 = {
                    # ship counter
                    # ceil(rand(0.25, 0.50) * ship_count)
                    set_variable_to_random_value = {
                        min = 0.25
                        max = 0.50
                        which = yukari_kamikakushi_ship_factor
                    }
                    export_trigger_value_to_variable = {
                        trigger = count_owned_ship
                        variable = yukari_kamikakushi_ship_counter
                    }
                    multiply_variable = {
                        which = yukari_kamikakushi_ship_counter
                        value = yukari_kamikakushi_ship_factor
                    }
                    ceiling_variable = yukari_kamikakushi_ship_counter
                    while = {
                        count = yukari_kamikakushi_ship_counter
                        random_owned_ship = {
                            ship_event = { id = Th_dynamic_battle_vict.8 }
                            ship_event = { id = Th_dynamic_battle_vict.10 days = 8 }
                        }
                    }
                }
                50 = {
                    # ship counter
                    # ceil(rand(0.10, 0.25) * ship_count / 100)
                    set_variable_to_random_value = {
                        min = 0.10
                        max = 0.25
                        which = yukari_kamikakushi_ship_factor
                    }
                    export_trigger_value_to_variable = {
                        trigger = count_owned_ship
                        variable = yukari_kamikakushi_ship_counter
                    }
                    multiply_variable = {
                        which = yukari_kamikakushi_ship_counter
                        value = yukari_kamikakushi_ship_factor
                    }
                    ceiling_variable = yukari_kamikakushi_ship_counter
                    while = {
                        count = yukari_kamikakushi_ship_counter
                        random_owned_ship = {
                            ship_event = { id = Th_dynamic_battle_vict.9 }
                            ship_event = { id = Th_dynamic_battle_vict.10 days = 8 }
                        }
                    }
                }
            }
            reroll_random = yes

            fleet_event = { id = Th_dynamic_battle_vict.6 days = 17 }
        } else = {
            remove_fleet_flag = spth_debuff_yukari_kamikakushi_0
            clear_variable = yukari_kamikakushi_ship_counter
            clear_variable = yukari_kamikakushi_ship_factor
        }
    }
}

# yukari kamikakushi_0 - 10%
ship_event = {
    id = Th_dynamic_battle_vict.7
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        has_ship_flag = spth_t0_yukari_kamikakushi_0
    }
    immediate = {
        spth_debuff_yukari_kamikakushi_0 = {
            inner_effect = spth_debuff_yukari_kamikakushi_0_t0
            caller = Th_dynamic_battle_vict.7
            flag = spth_t0_yukari_kamikakushi_0
        }
    }
}
# yukari kamikakushi_0 - 40%
ship_event = {
    id = Th_dynamic_battle_vict.8
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        has_ship_flag = spth_t1_yukari_kamikakushi_0
    }
    immediate = {
        spth_debuff_yukari_kamikakushi_0 = {
            inner_effect = spth_debuff_yukari_kamikakushi_0_t1
            caller = Th_dynamic_battle_vict.8
            flag = spth_t1_yukari_kamikakushi_0
        }
    }
}
# yukari kamikakushi_0 - 50%
ship_event = {
    id = Th_dynamic_battle_vict.9
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        has_ship_flag = spth_t2_yukari_kamikakushi_0
    }
    immediate = {
        spth_debuff_yukari_kamikakushi_0 = {
            inner_effect = spth_debuff_yukari_kamikakushi_0_t2
            caller = Th_dynamic_battle_vict.9
            flag = spth_t2_yukari_kamikakushi_0
        }
    }
}
# yukari kamikakushi_0 - clear debuff
ship_event = {
    id = Th_dynamic_battle_vict.10
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        NOR = {
            has_ship_flag = spth_t0_yukari_kamikakushi_0
            has_ship_flag = spth_t1_yukari_kamikakushi_0
            has_ship_flag = spth_t2_yukari_kamikakushi_0
        }
    }
    immediate = {
        TH_clear_all_dynamic_modifier = yes
    }
}

# This = our fleet
# From = enemy fleet
# FromFrom = our country
fleet_event = {
    id = Th_dynamic_battle_vict.11
    hide_window = yes
    is_triggered_only = yes
    immediate = {
        if = {
            limit = { is_in_combat = yes }
            every_owned_ship = {
                if = {
                    limit = { NOT = { has_ship_flag = koishi_combat_days_cooldown } }
                    change_variable = { which = koishi_combat_days value = 1 }
                }
                set_timed_ship_flag = { flag = koishi_combat_days_cooldown days = 1 }
            }
            # from = { every_owned_ship = { change_variable = { which = koishi_combat_days value = 1 } } }
            if = {
                limit = { fromfrom = { check_variable = { which = spth_koishi_lingli_var value > 0 } } }
                remove_fleet_flag = koishi_lack_lingli
                koishi_gal_combat_effect = yes
            } else = {
                if = {
                    limit = { NOT = { has_fleet_flag = koishi_lack_lingli } }
                    remove_fleet_flag = koishi_lack_lingli
                    remove_fleet_flag = koishi_combat_defence_cooldown
                    remove_fleet_flag = koishi_support_cooldown
                    remove_fleet_flag = koishi_combat_upgrade_finished
                    remove_modifier = koishi_improve_ship_hull
                    clear_variable = koishi_ship_hull_var
                    every_owned_ship = {
                        clear_variable = koishi_combat_days
                        clear_variable = koishi_repeatable_var
                        clear_variable = koishi_repeatable_rate
                        clear_variable = koishi_ship_hull_var
                        TH_clear_all_dynamic_modifier = yes
                    }
                    set_fleet_flag = koishi_lack_lingli
                }
            }
            fleet_event = {
                id = Th_dynamic_battle_vict.11
                days = 1
                scopes = {
                    from = from
                    fromfrom = fromfrom
                }
            }
        } else = {
            remove_fleet_flag = koishi_lack_lingli
            remove_fleet_flag = koishi_combat_defence_cooldown
            remove_fleet_flag = koishi_support_cooldown
            remove_fleet_flag = koishi_combat_upgrade_finished
            remove_modifier = koishi_improve_ship_hull
            clear_variable = koishi_ship_hull_var
            every_owned_ship = {
                clear_variable = koishi_combat_days
                clear_variable = koishi_repeatable_var
                clear_variable = koishi_repeatable_rate
                clear_variable = koishi_ship_hull_var
                TH_clear_all_dynamic_modifier = yes
            }
        }
    }
}

# 恋恋 - 舰船被击杀反击
# 击杀者船体受损，舰队随机修复一艘船
# This = owner of ship 1 (combatant)
# From = owner of ship 2 (destroyed)
# FromFrom = ship 1
# FromFromFrom = ship 2
country_event = {
    id = Th_dynamic_battle_vict.12
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        fromfromfrom = { is_ship_class = shipclass_military }
        from = {
            is_hostile_to = root
            has_country_flag = enable_koishi_fleet_support_6
        }
    }
    immediate = {
        fromfrom = {
            random_list = {
                15 = { koishi_reduce_hp_percent = { percent = 10 } }
                15 = { koishi_reduce_hp_percent = { percent = 20 } }
                15 = { koishi_reduce_hp_percent = { percent = 30 } }
                15 = { koishi_reduce_hp_percent = { percent = 40 } }
                10 = { koishi_reduce_hp_percent = { percent = 50 } }
                10 = { koishi_reduce_hp_percent = { percent = 60 } }
                10 = { koishi_reduce_hp_percent = { percent = 75 } }
                10 = { koishi_reduce_hp_percent = { percent = 85 } }
                5 = { koishi_reduce_hp_percent = { percent = 90 } }
                5 = { koishi_reduce_hp_percent = { percent = 95 } }
                1 = { koishi_reduce_hp_percent = { percent = 99 } }
                1 = { koishi_reduce_hp_rest = { rest = 1 } }
            }
            reroll_random = yes
            solar_system = {
                create_ambient_object = {
                    type = "star_explosion"
                    play_animation_once = yes
                    location = root.fromfrom
                    scale = 0.25
                }
                last_created_ambient_object = {
                    set_location = { target = root.fromfrom distance = 0 angle = random }
                }
            }
        }
        fromfromfrom.fleet = {
            random_list = {
                30 = { random_owned_ship = { repair_percentage = 0.10 } }
                30 = { random_owned_ship = { repair_percentage = 0.25 } }
                20 = { random_owned_ship = { repair_percentage = 0.35 } }
                19 = { random_owned_ship = { repair_percentage = 0.50 } }
                1 = { random_owned_ship = { repair_ship = yes } }
            }
            reroll_random = yes
        }
    }
}

# 恋恋 - 敌方交战取胜后清除modifiers
# This = fleet
fleet_event = {
    id = Th_dynamic_battle_vict.13
    hide_window = yes
    is_triggered_only = yes
    immediate = {
        if = {
            limit = { is_in_combat = yes }
            # do nothing.
            set_timed_fleet_flag = { flag = koishi_debug_enemy_in_combat days = 1 }
            fleet_event = { id = Th_dynamic_battle_vict.13 days = 1 }
        } else = {
            clear_variable = koishi_ship_count
            remove_fleet_flag = koishi_combat_assassin_cooldown
            every_owned_ship = {
                clear_variable = koishi_combat_days
                remove_ship_flag = koishi_combat_1_cooldown
                TH_clear_all_dynamic_modifier = yes
            }
        }
    }
}

# 护盾装甲效率 - 敌方
ship_event = {
    id = Th_dynamic_battle_vict.20
    hide_window = yes
    is_triggered_only = yes
    immediate = {
        if = {
            limit = { is_in_combat = yes }
            spth_armor_shield_efficiency_system_debuff = yes
            ship_event = { id = Th_dynamic_battle_vict.20 days = 1 }
        } else = {
            spth_armor_shield_efficiency_system_end = yes
        }
    }
}
# 护盾装甲效率 - 我方
ship_event = {
    id = Th_dynamic_battle_vict.21
    hide_window = yes
    is_triggered_only = yes
    immediate = {
        if = {
            limit = { is_in_combat = yes }
            spth_armor_shield_efficiency_system_buff = yes
            ship_event = { id = Th_dynamic_battle_vict.21 days = 1 }
        } else = {
            spth_armor_shield_efficiency_system_end = yes
        }
    }
}
# 护盾装甲效率 - 舰队检测
# from = enemy fleet
fleet_event = {
    id = Th_dynamic_battle_vict.22
    hide_window = yes
    is_triggered_only = yes
    immediate = {
        if = {
            limit = { is_in_combat = yes }
            spth_armor_shield_efficiency_system_check = yes
            fleet_event = {
                id = Th_dynamic_battle_vict.22
                days = 1
                scopes = { from = from }
            }
        } else = {
            spth_armor_shield_efficiency_system_end_fleet = yes
        }
    }
}

# Sakuya Sign Event
fleet_event = {
    id = Th_dynamic_battle_vict.102
    title = Th_dynamic_battle_vict.102
    desc = Th_dynamic_battle_vict.102_desc
    picture = GFX_evt_spth_wp_up_knife
    is_triggered_only = yes
    trigger = {
        # make sure only init at once.
        NOT = {
            owner = {
                has_country_flag = triggered_the_world_dynamic
            }
        }
    }
    immediate = {
        owner = {
            set_country_flag = triggered_the_world_dynamic
        }
    }
}

#############
# The world #
#############
# 触发事件
# FromFrom = our fleet
# FromFromFrom = enemy fleet
country_event = {
    id = Th_dynamic_battle_vict.1000
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        fromfrom = {
            any_owned_ship = {
                OR = {
                    has_component = th_ship_part_yueshiji
                    has_component = th_ship_part_yueshiji_story
                    has_component = th_ship_part_yueshiji_story_2
                }
            }
        }
        NOT = {
            fromfromfrom = {
                any_owned_ship = {
                    OR = {
                        has_component = th_ship_part_yueshiji
                        has_component = th_ship_part_yueshiji_story
                        has_component = th_ship_part_yueshiji_story_2
                    }
                }
            }
        }
    }

    immediate = {
        fromfrom = {
            fleet_event = { id = Th_dynamic_battle_vict.102 }
            if = {
                limit = {
                    any_owned_ship = {
                        has_component = th_ship_part_yueshiji_story_2
                    }
                }
                fromfromfrom = {
                    every_owned_ship = {
                        limit = { NOT = { has_ship_flag = TH_sakuya_the_world_dynamic_vict } }
                        set_timed_ship_flag = { flag = TH_sakuya_the_world_dynamic_vict days = @last_the_world_t3 }
                        ship_event = { id = Th_dynamic_battle_vict.1 }
                    }
                }
            }
            else_if = {
                limit = {
                    any_owned_ship = {
                        has_component = th_ship_part_yueshiji_story
                    }
                }
                fromfromfrom = {
                    every_owned_ship = {
                        limit = { NOT = { has_ship_flag = TH_sakuya_the_world_dynamic_vict } }
                        set_timed_ship_flag = { flag = TH_sakuya_the_world_dynamic_vict days = @last_the_world_t2 }
                        ship_event = { id = Th_dynamic_battle_vict.1 }
                    }
                }
            }
            else = {
                fromfromfrom = {
                    every_owned_ship = {
                        limit = { NOT = { has_ship_flag = TH_sakuya_the_world_dynamic_vict } }
                        set_timed_ship_flag = { flag = TH_sakuya_the_world_dynamic_vict days = @last_the_world_t1 }
                        ship_event = { id = Th_dynamic_battle_vict.1 }
                    }
                }
            }
        }
    }
}

################
# Satori's Eye #
################
# Trigger event
# FromFrom = our fleet
# FromFromFrom = enemy fleet
country_event = {
    id = Th_dynamic_battle_vict.1001
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        fromfrom = {
            any_owned_ship = {
                has_component = th_ship_part_satori
            }
        }
        NOT = {
            fromfromfrom = {
                any_owned_ship = {
                    has_component = th_ship_part_satori
                }
            }
        }
    }

    immediate = {
        fromfrom = {
            every_owned_ship = {
                limit = { NOT = { has_ship_flag = TH_satori_dynamic_boost } }
                set_timed_ship_flag = { flag = TH_satori_dynamic_boost days = @last_satori_eye }
                ship_event = { id = Th_dynamic_battle_vict.3 }
            }
        }
        fromfromfrom = {
            every_owned_ship = {
                limit = { NOT = { has_ship_flag = TH_satori_dynamic_vict } }
                set_timed_ship_flag = { flag = TH_satori_dynamic_vict days = @last_satori_eye }
                ship_event = { id = Th_dynamic_battle_vict.2 }
            }
        }
    }
}

################
# Koishi's Eye #
################
# Trigger event
# FromFrom = our fleet
# FromFromFrom = enemy fleet
country_event = {
    id = Th_dynamic_battle_vict.514
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        fromfrom = {
            any_owned_ship = {
                has_component = th_ship_part_koishi
            }
        }
        NOT = {
            fromfromfrom = {
                any_owned_ship = {
                    has_component = th_ship_part_koishi
                }
            }
        }
    }

    immediate = {
        fromfrom = {
            every_owned_ship = {
                limit = { NOT = { has_ship_flag = TH_koishi_dynamic_boost } }
                set_timed_ship_flag = { flag = TH_koishi_dynamic_boost days = @last_koishi_eye }
                ship_event = { id = Th_dynamic_battle_vict.5 }
            }
        }
        fromfromfrom = {
            every_owned_ship = {
                limit = { NOT = { has_ship_flag = TH_koishi_dynamic_vict } }
                set_timed_ship_flag = { flag = TH_koishi_dynamic_vict days = @last_koishi_eye }
                ship_event = { id = Th_dynamic_battle_vict.4 }
            }
        }
    }
}

########################
# yukari kamikakushi_0 #
########################
# 触发事件
# This = us
# From = enemy
# FromFrom = our fleet
# FromFromFrom = enemy fleet
country_event = {
    id = Th_dynamic_battle_vict.1002
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        fromfrom = {
            any_owned_ship = {
                has_component = spth_ship_part_kamikakushi_0
            }
        }
        NOT = {
            fromfromfrom = {
                any_owned_ship = {
                    has_component = spth_ship_part_kamikakushi_0
                }
            }
        }
    }
    immediate = {
        fromfromfrom = {
            fleet_event = { id = Th_dynamic_battle_vict.6 }
        }
    }
}

################
# Koishi Skill #
################
# 触发事件
# This = us
# From = enemy
# FromFrom = our fleet
# FromFromFrom = enemy fleet
country_event = {
    id = Th_dynamic_battle_vict.1003
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        exists = event_target:spth_gal_country_koishi
        has_communications = event_target:spth_gal_country_koishi
        has_authority = auth_gensokyo
        OR = {
            has_country_flag = enable_koishi_fleet_support_1
            has_country_flag = enable_koishi_fleet_support_2
            has_country_flag = enable_koishi_fleet_support_3
            has_country_flag = enable_koishi_fleet_support_4
            has_country_flag = enable_koishi_fleet_support_5
            has_country_flag = enable_koishi_fleet_support_6
        }
    }
    immediate = {
        fromfrom = {
            every_owned_ship = {
                if = {
                    limit = { NOT = { is_variable_set = koishi_combat_days } }
                    set_variable = { which = koishi_combat_days value = 0 }
                }
            }
            fleet_event = {
                id = Th_dynamic_battle_vict.11
                scopes = {
                    from = fromfromfrom
                    fromfrom = root
                }
            }
        }
        fromfromfrom = { fleet_event = { id = Th_dynamic_battle_vict.13 } }
    }
}

#################
# 护盾装甲效率机制 #
#################
# 触发事件
# This = us
# From = enemy
# FromFrom = our fleet
# FromFromFrom = enemy fleet
country_event = {
    id = Th_dynamic_battle_vict.1004
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        fromfrom = {
            any_owned_ship = {
                OR = {
                    check_modifier_value = { modifier = ship_spth_shield_efficiency value > 0 }
                    check_modifier_value = { modifier = ship_spth_armor_efficiency value > 0 }
                }
            }
        }
    }
    immediate = {
        # 硬化提升=护盾/装甲效率*100%
        fromfrom = {
            set_variable = { which = spth_shield_efficiency_count value = 0 }
            set_variable = { which = spth_armor_efficiency_count value = 0 }
            fleet_event = { id = Th_dynamic_battle_vict.22 scopes = { from = root.fromfromfrom } }
            every_owned_ship = {
                set_variable = { which = spth_shield_efficiency_var_hardening value = 0 }
                set_variable = { which = spth_armor_efficiency_var_hardening value = 0 }
                ship_event = { id = Th_dynamic_battle_vict.21 }
            }
        }
        fromfromfrom = {
            every_owned_ship = { ship_event = { id = Th_dynamic_battle_vict.20 } }
        }
    }
}

#############
# Test #
#############
# 触发事件
# FromFrom = our fleet
# FromFromFrom = enemy fleet
country_event = {
    id = Th_dynamic_battle_vict.300
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        has_country_flag = "TH_enable_db_test"
    }
    immediate = {
        fromfrom = {
            every_owned_ship = {
                limit = { NOT = { has_ship_flag = TH_test } }
                set_timed_ship_flag = { flag = TH_test days = 30 }
                ship_event = { id = Th_dynamic_battle_vict.301 }
            }
        }
    }
}

ship_event = {
    id = Th_dynamic_battle_vict.301
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        has_ship_flag = TH_test
    }
    immediate = { TH_test_boost = yes }
}

