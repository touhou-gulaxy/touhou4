namespace = spth_colony

# monthly update current barrier capacity and faith strength as planet variables (and more monthly refreshes)
country_event = {
	id = spth_colony.1
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_authority = auth_gensokyo }
	immediate = {
		every_owned_planet = {
			limit = {
				OR = {
					has_modifier = spth_planet_pop_convert
					has_deposit = d_hakurei_barrier
					NOR = {
						is_variable_set = planet_weak_genso_job_produce_faith_modifier
						is_variable_set = spth_planet_reactor_upkeep_mult
					}
				}
			}
			if = {
				limit = { has_deposit = d_hakurei_barrier }
				spth_effect_refresh_barrier_and_faith = yes
			}
			if = {
				limit = { NOT = { is_variable_set = planet_weak_genso_job_produce_faith_modifier } }
				set_variable = { which = planet_weak_genso_job_produce_faith_modifier value = 1 }
			}
			if = {
				limit = { NOT = { is_variable_set = spth_planet_reactor_upkeep_mult } }
				set_variable = { which = spth_planet_reactor_upkeep_mult value = 100 }
			}
			spth_count_to_be_converted_pops = yes
			if = {
				limit = { has_modifier = spth_planet_pop_convert }
				remove_modifier = spth_planet_pop_convert
				add_modifier = {
					modifier = spth_planet_pop_convert
					multiplier = spth_to_be_converted_pops_counter
				}
			}
		}
		if = {
			limit = { has_edict = spth_planet_dicisions_convert }
			every_owned_planet = {
				limit = { NOT = { has_modifier = spth_planet_pop_convert } }
				select_decision = {
					name = decision_gensokyo_pop_convert_activate
				}
			}
		}
		if = {
			limit = { has_edict = spth_planet_dicisions_sp }
			every_owned_planet = {
				if = {
					limit = { NOT = { has_deposit = d_hakurei_barrier } }
					select_decision = {
						name = decision_establish_barrier
					}
				}
			}
		}
	}
}

# update current barrier capacity as a planet variable when the save is loaded
event = {
	id = spth_colony.2
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		every_country = {
			limit = { has_authority = auth_gensokyo }
			country_event = { id = spth_colony.1 }
			country_event = { id = gensokyo_start.1145 }
		}
	}
}

# monthly update current barrier capacity as a planet variable
planet_event = {
	id = spth_colony.100
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		exists = owner
		owner = { has_authority = auth_gensokyo }
		OR = {
			has_modifier = spth_planet_pop_convert
			has_deposit = d_hakurei_barrier
		}
	}
	
	immediate = {
		if = {
			limit = { has_deposit = d_hakurei_barrier }
			set_variable = {
				which = planet_genso_job_buff_modifier
				value = value:planet_genso_job_buff_modifier
			}
		}
		spth_count_to_be_converted_pops = yes
		if = {
			limit = { has_modifier = spth_planet_pop_convert }
			remove_modifier = spth_planet_pop_convert
			add_modifier = {
				modifier = spth_planet_pop_convert
				multiplier = spth_to_be_converted_pops_counter
			}
		}
	}
}

country_event = {
	id = spth_colony.200
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		any_owned_planet = {
			has_planet_flag = megastructure
			has_planet_flag = is_spth_megastructure_planet
			num_pops > 1
		}
	}
	immediate = {
		every_owned_planet = {
			limit = {
				has_planet_flag = megastructure
				has_planet_flag = is_spth_megastructure_planet
				num_pops > 1
				is_colony = yes
			}
			planet_event = { id = spth_colony.201 }
		}
	}
}
planet_event = {
	id = spth_colony.201
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_planet_flag = megastructure
		has_planet_flag = is_spth_megastructure_planet
		num_pops > 1
	}
	immediate = {
		set_variable = { which = spth_megastructure_pop_count value = 0 }
		export_trigger_value_to_variable = {
			trigger = num_pops
			variable = spth_megastructure_pop_count
		}
		change_variable = { which = spth_megastructure_pop_count value = -1 }
		while = {
			count = spth_megastructure_pop_count
			random_owned_pop = { kill_pop = yes }
		}
	}
}

planet_event = {
	id = spth_colony.210
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		owner = {
			OR = {
				has_edict = spth_planet_dicisions_convert
				has_edict = spth_planet_dicisions_sp
			}
		}
	}
	immediate = {
		if = {
			limit = {
				owner = { has_edict = spth_planet_dicisions_convert }
				NOT = { has_modifier = spth_planet_pop_convert }
			}
			select_decision = {
				name = decision_gensokyo_pop_convert_activate
			}
		}
		if = {
			limit = { owner = { has_edict = spth_planet_dicisions_sp } }
			if = {
				limit = { NOT = { has_deposit = d_hakurei_barrier } }
				select_decision = {
					name = decision_establish_barrier
				}
			}
		}
	}
}

country_event = {
	id = spth_colony.3
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_authority = auth_gensokyo
		has_country_flag = spth_pop_convert_enabled
	}
	immediate = {
		every_owned_planet = {
			limit = { has_modifier = spth_planet_pop_convert }
			set_variable = { which = to_be_converted_amount value = 0 }
			export_trigger_value_to_variable = {
				trigger = num_assigned_jobs
				parameters = {
					job = spth_to_be_converted
				}
				variable = to_be_converted_amount
			}
			if = {
				limit = { check_variable = { which = to_be_converted_amount value >= 10 } }
				set_variable = { which = to_be_converted_amount value = 10 }
			}
			while = {
				count = to_be_converted_amount
				create_pop = { species = root.owner_main_species }
			}
			while = {
				count = to_be_converted_amount
				random_owned_pop = {
					limit = { has_job = spth_to_be_converted }
					kill_pop = yes
				}
			}
			spth_count_to_be_converted_pops = yes
			if = {
				limit = { has_modifier = spth_planet_pop_convert }
				remove_modifier = spth_planet_pop_convert
				add_modifier = {
					modifier = spth_planet_pop_convert
					multiplier = spth_to_be_converted_pops_counter
				}
			}
		}
	}
}

planet_event = {
	id = spth_colony.1000
	title = spth_colony.1000
	desc = spth_colony.1000.desc
	picture = GFX_evt_hakurei_shrine_in_night
	is_triggered_only = yes
	option = {
		name = spth_colony.1000.a
		hidden_effect = {
			remove_planet_flag = spth_torifune_shrine_research_mode_soc
			remove_planet_flag = spth_torifune_shrine_research_mode_eng
			set_planet_flag = spth_torifune_shrine_research_mode_phy
			planet_event = { id = spth_colony.1000 }
		}
	}
	option = {
		name = spth_colony.1000.b
		hidden_effect = {
			remove_planet_flag = spth_torifune_shrine_research_mode_soc
			set_planet_flag = spth_torifune_shrine_research_mode_eng
			remove_planet_flag = spth_torifune_shrine_research_mode_phy
			planet_event = { id = spth_colony.1000 }
		}
	}
	option = {
		name = spth_colony.1000.c
		hidden_effect = {
			set_planet_flag = spth_torifune_shrine_research_mode_soc
			remove_planet_flag = spth_torifune_shrine_research_mode_eng
			remove_planet_flag = spth_torifune_shrine_research_mode_phy
			planet_event = { id = spth_colony.1000 }
		}
	}
	option = {
		name = spth_colony.1000.exit
		default_hide_option = yes
	}
}

planet_event = {
	id = spth_colony.11
	title = spth_colony.11
	desc = spth_colony.11.desc
	picture = GFX_evt_hakurei_shrine_in_night
	is_triggered_only = yes
	trigger = { NOT = { has_planet_flag = has_open_spth_reactor_adjust_ui } }
	diplomatic = yes
	custom_gui = spiritual_power_reactor_ui
	custom_gui_option = spiritual_power_reactor_button
	picture_event_data = { room = hiff_story_shrine_room }
	immediate = {
		set_planet_flag = has_open_spth_reactor_adjust_ui
		if = {
			limit = { NOT = { is_variable_set = spth_planet_reactor_upkeep_mult } }
			set_variable = { which = spth_planet_reactor_upkeep_mult value = 100 }
		}
		set_variable = { which = spth_planet_reactor_display_produce value = value:spth_planet_reactor_procude_mult }
	}
	after = {
		hidden_effect = {
			clear_variable = spth_planet_reactor_display_produce
			remove_planet_flag = has_open_spth_reactor_adjust_ui
		}
		if = {
			limit = { has_planet_flag = close_spth_planet_reactor_ui }
			remove_planet_flag = close_spth_planet_reactor_ui
			owner = { remove_country_flag = has_open_gui_spth_colony_11 }
		} else = { planet_event = { id = spth_colony.11 } }
	}
	option = {
		name = spth_colony.11.a
		custom_tooltip = spth_colony.11.tooltip
		hidden_effect = {
			remove_planet_flag = spth_planet_reactor_use_food
			remove_planet_flag = spth_planet_reactor_use_minerals
			remove_planet_flag = spth_planet_reactor_use_consumer_goods
		}
	}
	option = {
		name = spth_colony.11.b
		custom_tooltip = spth_colony.11.tooltip
		hidden_effect = {
			set_planet_flag = spth_planet_reactor_use_food
			remove_planet_flag = spth_planet_reactor_use_minerals
			remove_planet_flag = spth_planet_reactor_use_consumer_goods
		}
	}
	option = {
		name = spth_colony.11.c
		custom_tooltip = spth_colony.11.tooltip
		hidden_effect = {
			remove_planet_flag = spth_planet_reactor_use_food
			set_planet_flag = spth_planet_reactor_use_minerals
			remove_planet_flag = spth_planet_reactor_use_consumer_goods
		}
	}
	option = {
		name = spth_colony.11.d
		custom_tooltip = spth_colony.11.tooltip
		hidden_effect = {
			remove_planet_flag = spth_planet_reactor_use_food
			remove_planet_flag = spth_planet_reactor_use_minerals
			set_planet_flag = spth_planet_reactor_use_consumer_goods
		}
	}
	option = {
		name = spth_colony.11.exit
		custom_tooltip = spth_colony.11.tooltip
		default_hide_option = yes
		hidden_effect = { set_planet_flag = close_spth_planet_reactor_ui }
	}
}
