TH_clear_ship_modifier = {
    optimize_memory
    export_modifier_to_variable = { modifier = $modifier$ variable = th_$modifier$_calc_value }
    [[minus] subtract_variable = { which = th_$modifier$_calc_value value = $minus$ } ]
    [[add] change_variable = { which = th_$modifier$_calc_value value = $add$ } ]
    [[mul] multiply_variable = { which = th_$modifier$_calc_value value = $mul$ } ]
    [[div] divide_variable = { which = th_$modifier$_calc_value value = $div$ } ]
    add_modifier = { modifier = TH_dynamic_remove_$modifier$ multiplier = th_$modifier$_calc_value }
    clear_variable = th_$modifier$_calc_value
}

TH_add_modifier = {
    optimize_memory
    export_modifier_to_variable = { modifier = $modifier$ variable = th_$modifier$_calc_value }
    add_modifier = { modifier = TH_dynamic_reset_$modifier$ multiplier = $value$ }
    clear_variable = th_$modifier$_calc_value
}

TH_dynamic_modifier_conditional = {
    optimize_memory
    export_modifier_to_variable = {
        modifier = $modifier$
        variable = spth_$modifier$_calc_value
    }
    if = {
        limit = {
            NOT = { has_ship_flag = spth_$modifier$_checked }
        }
        if = {
            limit = { check_variable = { which = spth_$modifier$_calc_value value $relation$ $limit_value$ } }
            set_timed_ship_flag = { flag = spth_$modifier$_checked days = 1 }
            add_modifier = { modifier = TH_dynamic_remove_$modifier$ multiplier = spth_$modifier$_calc_value }
            add_modifier = { modifier = TH_dynamic_reset_$modifier$ multiplier = $value$ }
        }
    }
    clear_variable = spth_$modifier$_calc_value
}
TH_timed_check_modifier = {
    optimize_memory
    export_modifier_to_variable = {
        modifier = $modifier$
        variable = spth_check_value_$modifier$
    }
    if = {
        limit = {
            check_variable = { which = spth_check_value_$modifier$ value $relation$ $check_value$ }
        }
        set_timed_ship_flag = { flag = spth_check_value_$modifier$_checkpoint days = 1 }
        add_modifier = { modifier = TH_dynamic_remove_$modifier$ multiplier = spth_check_value_$modifier$ days = $days$ }
        add_modifier = { modifier = TH_dynamic_reset_$modifier$ multiplier = $value$ days = $days$ }
    }
    clear_variable = spth_check_value_$modifier$
}

sakuya_the_world_dynamic = {
    optimize_memory
    if = {
        limit = {
            is_in_combat = yes
        }

        TH_dynamic_modifier_conditional = { modifier = ship_accuracy_mult relation = ">" limit_value = -1 value = -1 }
        TH_dynamic_modifier_conditional = { modifier = ship_speed_mult relation = ">" limit_value = -1 value = -1 }
        TH_dynamic_modifier_conditional = { modifier = ship_fire_rate_mult relation = ">" limit_value = -1 value = -1 }
        TH_dynamic_modifier_conditional = { modifier = ship_evasion_mult relation = ">" limit_value = -1 value = -1 }
        TH_dynamic_modifier_conditional = { modifier = ship_tracking_mult relation = ">" limit_value = -1 value = -1 }

        ship_event = { id = Th_dynamic_battle_vict.1 days = $interval$ }
    } else = {
        TH_clear_all_dynamic_modifier = yes
        if = {
            limit = { has_ship_flag = TH_sakuya_the_world_dynamic_vict }
            remove_ship_flag = TH_sakuya_the_world_dynamic_vict
        }
    }
}

satori_dynamic_battle = {
    optimize_memory
    if = {
        limit = { is_in_combat = yes }

        TH_dynamic_modifier_conditional = { modifier = ship_evasion_mult relation = ">" limit_value = -1 value = -1 }

        ship_event = { id = Th_dynamic_battle_vict.2 days = $interval$ }
    }
    else = {
        TH_clear_all_dynamic_modifier = yes
        if = {
            limit = { has_ship_flag = TH_satori_dynamic_vict }
            remove_ship_flag = TH_satori_dynamic_vict
        }
    }
}

satori_dynamic_boost = {
    optimize_memory
    if = {
        limit = { is_in_combat = yes }

        TH_dynamic_modifier_conditional = { modifier = ship_accuracy_add relation = "<" limit_value = 1 value = 1 }
        TH_dynamic_modifier_conditional = { modifier = ship_accuracy_mult relation = "<" limit_value = 1 value = 1 }

        ship_event = { id = Th_dynamic_battle_vict.3 days = $interval$ }
    }
    else = {
        TH_clear_all_dynamic_modifier = yes
        if = {
            limit = { has_ship_flag = TH_satori_dynamic_boost }
            remove_ship_flag = TH_satori_dynamic_boost
        }
    }
}

koishi_dynamic_battle = {
    optimize_memory
    if = {
        limit = { is_in_combat = yes }

        TH_dynamic_modifier_conditional = { modifier = ship_accuracy_mult relation = ">" limit_value = -1 value = -1 }
        TH_dynamic_modifier_conditional = { modifier = ship_tracking_mult relation = ">" limit_value = -1 value = -1 }

        ship_event = { id = Th_dynamic_battle_vict.4 days = $interval$ }
    }
    else = {
        TH_clear_all_dynamic_modifier = yes
        if = {
            limit = { has_ship_flag = TH_koishi_dynamic_vict }
            remove_ship_flag = TH_koishi_dynamic_vict
        }
    }
}

koishi_dynamic_boost = {
    optimize_memory
    if = {
        limit = { is_in_combat = yes }

        TH_dynamic_modifier_conditional = { modifier = ship_evasion_mult relation = "<" limit_value = 1 value = 1 }

        ship_event = { id = Th_dynamic_battle_vict.5 days = $interval$ }
    }
    else = {
        TH_clear_all_dynamic_modifier = yes
        if = {
            limit = { has_ship_flag = TH_koishi_dynamic_boost }
            remove_ship_flag = TH_koishi_dynamic_boost
        }
    }
}

TH_test_boost = {
    optimize_memory
    if = {
        limit = { is_in_combat = yes }

        TH_dynamic_modifier_conditional = { modifier = ship_armor_hardening_add relation = "<" limit_value = 0.50 value = 0.50 }
        TH_dynamic_modifier_conditional = { modifier = ship_shield_hardening_add relation = "<" limit_value = 0.50 value = 0.50 }

        ship_event = { id = Th_dynamic_battle_vict.301 days = 2 }
    } else = {
        TH_clear_all_dynamic_modifier = yes
        if = {
            limit = {
                has_ship_flag = TH_test
            }
            remove_ship_flag = TH_test
        }
    }
}

spth_debuff_yukari_kamikakushi_0 = {
    optimize_memory
    if = {
        limit = { is_in_combat = yes }

        $inner_effect$ = yes

        ship_event = { id = $caller$ days = 1 }
    } else = {
        TH_clear_all_dynamic_modifier = yes
        remove_ship_flag = $flag$
    }
}
spth_debuff_yukari_kamikakushi_0_t0 = {
    optimize_memory
    TH_dynamic_modifier_conditional = {
        modifier = ship_evasion_mult
        limit_value = -0.95
        relation = ">"
        value = -0.95
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_accuracy_mult
        limit_value = -0.95
        relation = ">"
        value = -0.95
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_tracking_mult
        limit_value = -0.95
        relation = ">"
        value = -0.95
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_evasion_add
        limit_value = 0
        relation = ">"
        value = 0
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_accuracy_add
        limit_value = 0
        relation = ">"
        value = 0
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_tracking_add
        limit_value = 0
        relation = ">"
        value = 0
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_shield_hardening_add
        limit_value = -1
        relation = ">"
        value = -1
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_armor_hardening_add
        limit_value = -1
        relation = ">"
        value = -1
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_shield_penetration_mult
        limit_value = -1
        relation = ">"
        value = -1
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_armor_penetration_mult
        limit_value = -1
        relation = ">"
        value = -1
    }
}
spth_debuff_yukari_kamikakushi_0_t1 = {
    optimize_memory
    TH_dynamic_modifier_conditional = {
        modifier = ship_evasion_mult
        limit_value = -1
        relation = ">"
        value = -1
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_accuracy_mult
        limit_value = -1
        relation = ">"
        value = -1
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_tracking_mult
        limit_value = -1
        relation = ">"
        value = -1
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_fire_rate_mult
        limit_value = -1
        relation = ">"
        value = -1
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_weapon_damage
        limit_value = -1
        relation = ">"
        value = -1
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_speed_mult
        limit_value = -1
        relation = ">"
        value = -1
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_weapon_range_mult
        limit_value = -1
        relation = ">"
        value = -1
    }
}
spth_debuff_yukari_kamikakushi_0_t2 = {
    optimize_memory
    TH_dynamic_modifier_conditional = {
        modifier = ship_weapon_damage
        limit_value = -0.9
        relation = ">"
        value = -0.9
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_armor_regen_add_perc
        limit_value = 0
        relation = ">"
        value = 0
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_shield_regen_add_perc
        limit_value = 0
        relation = ">"
        value = 0
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_hull_regen_add_perc
        limit_value = 0
        relation = ">"
        value = 0
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_shield_hardening_add
        limit_value = -1
        relation = ">"
        value = -1
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_armor_hardening_add
        limit_value = -1
        relation = ">"
        value = -1
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_shield_penetration_mult
        limit_value = -1
        relation = ">"
        value = -1
    }
    TH_dynamic_modifier_conditional = {
        modifier = ship_armor_penetration_mult
        limit_value = -1
        relation = ">"
        value = -1
    }
}

# 检测舰队装甲与护盾效率
spth_armor_shield_efficiency_system_check = {
    optimize_memory
    export_trigger_value_to_variable = {
        trigger = count_owned_ship
        variable = spth_shield_efficiency_count
        parameters = { limit = { check_modifier_value = { modifier = ship_spth_shield_efficiency value > 0 } } }
    }
    export_trigger_value_to_variable = {
        trigger = count_owned_ship
        variable = spth_armor_efficiency_count
        parameters = { limit = { check_modifier_value = { modifier = ship_spth_shield_efficiency value > 0 } } }
    }
    if = {
        limit = { check_variable = { which = spth_shield_efficiency_count value > 0 } }
        if = {
            limit = { NOT = { has_fleet_flag = has_spth_shield_efficiency_buff } }
            set_fleet_flag = has_spth_shield_efficiency_buff
            from = { every_owned_ship = { set_ship_flag = has_spth_shield_efficiency_debuff } }
        }
    } else = {
        remove_fleet_flag = has_spth_shield_efficiency_buff
        from = { every_owned_ship = { remove_ship_flag = has_spth_shield_efficiency_debuff } }
    }
    if = {
        limit = { check_variable = { which = spth_armor_efficiency_count value > 0 } }
        if = {
            limit = { NOT = { has_fleet_flag = has_spth_armor_efficiency_buff } }
            set_fleet_flag = has_spth_armor_efficiency_buff
            from = { every_owned_ship = { set_ship_flag = has_spth_armor_efficiency_debuff } }
        }
    } else = {
        remove_fleet_flag = has_spth_armor_efficiency_buff
        from = { every_owned_ship = { remove_ship_flag = has_spth_armor_efficiency_debuff } }
    }
}
# 加成系统
spth_armor_shield_efficiency_system_buff = {
    optimize_memory
    if = {
        limit = { check_modifier_value = { modifier = ship_spth_shield_efficiency value > 0 } }
        export_modifier_to_variable = {
            modifier = ship_shield_hardening_add
            variable = spth_shield_efficiency_var_hardening
        }
        subtract_variable = {
            which = spth_shield_efficiency_var_hardening
            value = value:ship_spth_shield_efficiency_value
        }
        if = {
            limit = {
                check_variable = { which = spth_shield_efficiency_var_hardening value < 0 }
            }
            add_modifier = { modifier = spth_shield_efficiency_hardening multiplier = spth_shield_efficiency_var_hardening }
        }
    }
    if = {
        limit = { check_modifier_value = { modifier = ship_spth_armor_efficiency value > 0 } }
        export_modifier_to_variable = {
            modifier = ship_armor_hardening_add
            variable = spth_armor_efficiency_var_hardening
        }
        subtract_variable = {
            which = spth_armor_efficiency_var_hardening
            value = value:ship_spth_shield_efficiency_value
        }
        if = {
            limit = {
                check_variable = { which = spth_armor_efficiency_var_hardening value < 0 }
            }
            add_modifier = { modifier = spth_armor_efficiency_hardening multiplier = spth_armor_efficiency_var_hardening }
        }
    }
}
# 减益系统
spth_armor_shield_efficiency_system_debuff = {
    optimize_memory
    if = {
        limit = { has_ship_flag = has_spth_shield_efficiency_debuff }
        TH_dynamic_modifier_conditional = {
            modifier = "ship_shield_penetration_mult"
            relation = ">"
            limit_value = 1
            value = 1
        }
        TH_dynamic_modifier_conditional = {
            modifier = "ship_shield_penetration_add"
            relation = ">"
            limit_value = 1
            value = 1
        }
    }
    if = {
        limit = { has_ship_flag = has_spth_armor_efficiency_debuff }
        TH_dynamic_modifier_conditional = {
            modifier = "ship_armor_penetration_mult"
            relation = ">"
            limit_value = 1
            value = 1
        }
        TH_dynamic_modifier_conditional = {
            modifier = "ship_armor_penetration_add"
            relation = ">"
            limit_value = 1
            value = 1
        }
    }
}
# 系统结束运行
spth_armor_shield_efficiency_system_end = {
    optimize_memory
    clear_variable = spth_shield_efficiency_var_hardening
    clear_variable = spth_armor_efficiency_var_hardening
    remove_ship_flag = has_spth_shield_efficiency_debuff
    remove_ship_flag = has_spth_armor_efficiency_debuff
    remove_modifier = spth_shield_efficiency_hardening
    remove_modifier = spth_armor_efficiency_hardening
    TH_clear_all_dynamic_modifier = yes
}
spth_armor_shield_efficiency_system_end_fleet = {
    optimize_memory
    clear_variable = spth_shield_efficiency_count
    clear_variable = spth_armor_efficiency_count
    remove_fleet_flag = has_spth_shield_efficiency_buff
    remove_fleet_flag = has_spth_armor_efficiency_buff
}

TH_clear_all_dynamic_modifier = {
    optimize_memory
    # 一次修正使用
    remove_modifier = TH_dynamic_remove_ship_fire_rate_mult
    remove_modifier = TH_dynamic_remove_ship_speed_mult
    remove_modifier = TH_dynamic_remove_ship_shield_penetration_mult
    remove_modifier = TH_dynamic_remove_ship_armor_penetration_mult
    remove_modifier = TH_dynamic_remove_ship_armor_damage_mult
    remove_modifier = TH_dynamic_remove_ship_shield_damage_mult
    remove_modifier = TH_dynamic_remove_ship_hull_damage_mult
    remove_modifier = TH_dynamic_remove_ship_tracking_mult
    remove_modifier = TH_dynamic_remove_ship_accuracy_mult
    remove_modifier = TH_dynamic_remove_ship_weapon_damage
    remove_modifier = TH_dynamic_remove_ship_hull_regen_add_perc
    remove_modifier = TH_dynamic_remove_ship_armor_regen_add_perc
    remove_modifier = TH_dynamic_remove_ship_shield_regen_add_perc
    remove_modifier = TH_dynamic_remove_ship_hull_mult
    remove_modifier = TH_dynamic_remove_ship_armor_mult
    remove_modifier = TH_dynamic_remove_ship_shield_mult
    remove_modifier = TH_dynamic_remove_ship_shield_reduction
    remove_modifier = TH_dynamic_remove_ship_armor_reduction
    remove_modifier = TH_dynamic_remove_ship_weapon_range_mult
    remove_modifier = TH_dynamic_remove_ship_tracking_add
    remove_modifier = TH_dynamic_remove_ship_accuracy_add
    remove_modifier = TH_dynamic_remove_ship_armor_add
    remove_modifier = TH_dynamic_remove_ship_shield_add
    remove_modifier = TH_dynamic_remove_ship_armor_hardening_add
    remove_modifier = TH_dynamic_remove_ship_shield_hardening_add
    remove_modifier = TH_dynamic_remove_ship_evasion_mult
    remove_modifier = TH_dynamic_remove_ship_evasion_add

    # 二次修正使用
    remove_modifier = TH_dynamic_reset_ship_speed_mult
    remove_modifier = TH_dynamic_reset_ship_shield_penetration_mult
    remove_modifier = TH_dynamic_reset_ship_armor_penetration_mult
    remove_modifier = TH_dynamic_reset_ship_armor_damage_mult
    remove_modifier = TH_dynamic_reset_ship_shield_damage_mult
    remove_modifier = TH_dynamic_reset_ship_hull_damage_mult
    remove_modifier = TH_dynamic_reset_ship_tracking_mult
    remove_modifier = TH_dynamic_reset_ship_accuracy_mult
    remove_modifier = TH_dynamic_reset_ship_weapon_damage
    remove_modifier = TH_dynamic_reset_ship_weapon_range_mult
    remove_modifier = TH_dynamic_reset_ship_fire_rate_mult
    remove_modifier = TH_dynamic_reset_ship_hull_regen_add_perc
    remove_modifier = TH_dynamic_reset_ship_armor_regen_add_perc
    remove_modifier = TH_dynamic_reset_ship_shield_regen_add_perc
    remove_modifier = TH_dynamic_reset_ship_hull_mult
    remove_modifier = TH_dynamic_reset_ship_armor_mult
    remove_modifier = TH_dynamic_reset_ship_shield_mult
    remove_modifier = TH_dynamic_reset_ship_shield_reduction
    remove_modifier = TH_dynamic_reset_ship_armor_reduction
    remove_modifier = TH_dynamic_reset_ship_tracking_add
    remove_modifier = TH_dynamic_reset_ship_accuracy_add
    remove_modifier = TH_dynamic_reset_ship_armor_add
    remove_modifier = TH_dynamic_reset_ship_shield_add
    remove_modifier = TH_dynamic_reset_ship_armor_hardening_add
    remove_modifier = TH_dynamic_reset_ship_shield_hardening_add
    remove_modifier = TH_dynamic_reset_ship_evasion_mult
    remove_modifier = TH_dynamic_reset_ship_evasion_add

    remove_modifier = koishi_improve_energy_damage
    remove_modifier = koishi_improve_kinetic_damage
    remove_modifier = koishi_improve_explosive_damage
    remove_modifier = koishi_improve_special_damage
}