TH_clear_ship_modifier = {
    optimize_memory
    export_modifier_to_variable = { modifier = $modifier$ variable = th_$modifier$_calc_value }
    [[minus] subtract_variable = { which = th_$modifier$_calc_value value = $minus$ } ]
    [[add] change_variable = { which = th_$modifier$_calc_value value = $add$ } ]
    [[mul] multiply_variable = { which = th_$modifier$_calc_value value = $mul$ } ]
    [[div] divide_variable = { which = th_$modifier$_calc_value value = $div$ } ]
    add_modifier = { modifier = TH_dynamic_remove_$modifier$ multiplier = th_$modifier$_calc_value }
    clear_variable = th_$modifier$_calc_value
}

TH_add_modifier = {
    optimize_memory
    export_modifier_to_variable = { modifier = $modifier$ variable = th_$modifier$_calc_value }
    add_modifier = { modifier = TH_dynamic_reset_$modifier$ multiplier = $value$ }
    clear_variable = th_$modifier$_calc_value
}

TH_dynamic_modifier_conditional = {
    optimize_memory
    if = {
        limit = {
            NOT = { has_ship_flag = TH_has_cond_$modifier$ }
        }
        if = {
            limit = { check_modifier_value = { modifier = $modifier$ value $relation$ $limit_value$ } }
            set_timed_ship_flag = { flag = TH_has_cond_$modifier$ days = 1 }
        }
    }
    if = {
        limit = {
            has_ship_flag = TH_has_cond_$modifier$
        }
        TH_clear_ship_modifier = { modifier = $modifier$ }
        TH_add_modifier = { modifier = $modifier$ value = $value$ }
    }
}

sakuya_the_world_dynamic = {
    optimize_memory
    if = {
        limit = {
            is_in_combat = yes
        }

        TH_dynamic_modifier_conditional = { modifier = ship_accuracy_mult relation = ">" limit_value = -1 value = -1 }
        TH_dynamic_modifier_conditional = { modifier = ship_speed_mult relation = ">" limit_value = -1 value = -1 }
        TH_dynamic_modifier_conditional = { modifier = ship_fire_rate_mult relation = ">" limit_value = -1 value = -1 }
        TH_dynamic_modifier_conditional = { modifier = ship_evasion_mult relation = ">" limit_value = -1 value = -1 }
        TH_dynamic_modifier_conditional = { modifier = ship_tracking_mult relation = ">" limit_value = -1 value = -1 }

        ship_event = { id = Th_dynamic_battle_vict.1 days = $interval$ }
    } else = {
        TH_clear_all_dynamic_modifier = yes
        if = {
            limit = { has_ship_flag = TH_sakuya_the_world_dynamic_vict }
            remove_ship_flag = TH_sakuya_the_world_dynamic_vict
        }
    }
}

satori_dynamic_battle = {
    optimize_memory
    if = {
        limit = { is_in_combat = yes }

        TH_dynamic_modifier_conditional = { modifier = ship_evasion_mult relation = ">" limit_value = -1 value = -1 }

        ship_event = { id = Th_dynamic_battle_vict.2 days = $interval$ }
    }
    else = {
        TH_clear_all_dynamic_modifier = yes
        if = {
            limit = { has_ship_flag = TH_satori_dynamic_vict }
            remove_ship_flag = TH_satori_dynamic_vict
        }
    }
}

satori_dynamic_boost = {
    optimize_memory
    if = {
        limit = { is_in_combat = yes }

        TH_dynamic_modifier_conditional = { modifier = ship_accuracy_add relation = ">" limit_value = -1 value = -1 }
        TH_dynamic_modifier_conditional = { modifier = ship_accuracy_mult relation = ">" limit_value = -1 value = -1 }

        ship_event = { id = Th_dynamic_battle_vict.3 days = $interval$ }
    }
    else = {
        TH_clear_all_dynamic_modifier = yes
        if = {
            limit = { has_ship_flag = TH_satori_dynamic_boost }
            remove_ship_flag = TH_satori_dynamic_boost
        }
    }
}

koishi_dynamic_battle = {
    optimize_memory
    if = {
        limit = { is_in_combat = yes }

        TH_dynamic_modifier_conditional = { modifier = ship_accuracy_mult relation = ">" limit_value = -1 value = -1 }
        TH_dynamic_modifier_conditional = { modifier = ship_tracking_mult relation = ">" limit_value = -1 value = -1 }

        ship_event = { id = Th_dynamic_battle_vict.4 days = $interval$ }
    }
    else = {
        TH_clear_all_dynamic_modifier = yes
        if = {
            limit = { has_ship_flag = TH_koishi_dynamic_vict }
            remove_ship_flag = TH_koishi_dynamic_vict
        }
    }
}

koishi_dynamic_boost = {
    optimize_memory
    if = {
        limit = { is_in_combat = yes }

        TH_dynamic_modifier_conditional = { modifier = ship_evasion_mult relation = ">" limit_value = -1 value = -1 }

        ship_event = { id = Th_dynamic_battle_vict.5 days = $interval$ }
    }
    else = {
        TH_clear_all_dynamic_modifier = yes
        if = {
            limit = { has_ship_flag = TH_koishi_dynamic_boost }
            remove_ship_flag = TH_koishi_dynamic_boost
        }
    }
}

TH_test_boost = {
    optimize_memory
    if = {
        limit = { is_in_combat = yes }

        TH_dynamic_modifier_conditional = { modifier = ship_armor_hardening_add relation = "<" limit_value = 0.50 value = 0.50 }
        TH_dynamic_modifier_conditional = { modifier = ship_shield_hardening_add relation = "<" limit_value = 0.50 value = 0.50 }

        ship_event = { id = Th_dynamic_battle_vict.301 days = 2 }
    } else = {
        TH_clear_all_dynamic_modifier = yes
        if = {
            limit = {
                has_ship_flag = TH_test
            }
            remove_ship_flag = TH_test
        }
    }
}

TH_clear_all_dynamic_modifier = {
    optimize_memory
    # 一次修正使用
    remove_modifier = TH_dynamic_remove_ship_fire_rate_mult
    remove_modifier = TH_dynamic_remove_ship_speed_mult
    remove_modifier = TH_dynamic_remove_ship_shield_penetration_mult
    remove_modifier = TH_dynamic_remove_ship_armor_penetration_mult
    remove_modifier = TH_dynamic_remove_ship_armor_damage_mult
    remove_modifier = TH_dynamic_remove_ship_shield_damage_mult
    remove_modifier = TH_dynamic_remove_ship_hull_damage_mult
    remove_modifier = TH_dynamic_remove_ship_tracking_mult
    remove_modifier = TH_dynamic_remove_ship_accuracy_mult
    remove_modifier = TH_dynamic_remove_ship_weapon_damage
    remove_modifier = TH_dynamic_remove_ship_hull_regen_add_perc
    remove_modifier = TH_dynamic_remove_ship_armor_regen_add_perc
    remove_modifier = TH_dynamic_remove_ship_shield_regen_add_perc
    remove_modifier = TH_dynamic_remove_ship_hull_mult
    remove_modifier = TH_dynamic_remove_ship_armor_mult
    remove_modifier = TH_dynamic_remove_ship_shield_mult
    remove_modifier = TH_dynamic_remove_ship_shield_reduction
    remove_modifier = TH_dynamic_remove_ship_armor_reduction
    remove_modifier = TH_dynamic_remove_ship_weapon_range_mult
    remove_modifier = TH_dynamic_remove_ship_tracking_add
    remove_modifier = TH_dynamic_remove_ship_accuracy_add
    remove_modifier = TH_dynamic_remove_ship_armor_add
    remove_modifier = TH_dynamic_remove_ship_shield_add
    remove_modifier = TH_dynamic_remove_ship_armor_hardening_add
    remove_modifier = TH_dynamic_remove_ship_shield_hardening_add
    remove_modifier = TH_dynamic_remove_ship_evasion_mult
    remove_modifier = TH_dynamic_remove_ship_evasion_add

    # 二次修正使用
    remove_modifier = TH_dynamic_reset_ship_speed_mult
    remove_modifier = TH_dynamic_reset_ship_shield_penetration_mult
    remove_modifier = TH_dynamic_reset_ship_armor_penetration_mult
    remove_modifier = TH_dynamic_reset_ship_armor_damage_mult
    remove_modifier = TH_dynamic_reset_ship_shield_damage_mult
    remove_modifier = TH_dynamic_reset_ship_hull_damage_mult
    remove_modifier = TH_dynamic_reset_ship_tracking_mult
    remove_modifier = TH_dynamic_reset_ship_accuracy_mult
    remove_modifier = TH_dynamic_reset_ship_weapon_damage
    remove_modifier = TH_dynamic_reset_ship_weapon_range_mult
    remove_modifier = TH_dynamic_reset_ship_fire_rate_mult
    remove_modifier = TH_dynamic_reset_ship_hull_regen_add_perc
    remove_modifier = TH_dynamic_reset_ship_armor_regen_add_perc
    remove_modifier = TH_dynamic_reset_ship_shield_regen_add_perc
    remove_modifier = TH_dynamic_reset_ship_hull_mult
    remove_modifier = TH_dynamic_reset_ship_armor_mult
    remove_modifier = TH_dynamic_reset_ship_shield_mult
    remove_modifier = TH_dynamic_reset_ship_shield_reduction
    remove_modifier = TH_dynamic_reset_ship_armor_reduction
    remove_modifier = TH_dynamic_reset_ship_tracking_add
    remove_modifier = TH_dynamic_reset_ship_accuracy_add
    remove_modifier = TH_dynamic_reset_ship_armor_add
    remove_modifier = TH_dynamic_reset_ship_shield_add
    remove_modifier = TH_dynamic_reset_ship_armor_hardening_add
    remove_modifier = TH_dynamic_reset_ship_shield_hardening_add
    remove_modifier = TH_dynamic_reset_ship_evasion_mult
    remove_modifier = TH_dynamic_reset_ship_evasion_add
}