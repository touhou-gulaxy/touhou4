TH_capture_defender_army = {
    optimize_memory
    set_variable = { which = TH_capture_enemies_count value = This.TH_planet_defender_count }
    multiply_variable = { which = TH_capture_enemies_count value = $mul$ }
    floor_variable = TH_capture_enemies_count
    change_variable = { which = TH_capture_enemies_count value = 1 }

    create_fleet = {
        name = NAME_TH_captured_armies
        effect = {
            set_owner = $OWNER$
            while = {
                count = prev.TH_capture_enemies_count
                create_army_transport = {
                    ship_name = NAME_TH_captured_army
                    army_name = NAME_TH_captured_army
                    army_type = $TYPE$
                    species = owner_species
                }
            }
            set_location = {
                target = $TARGET$
                distance = 45
                angle = random
            }
        }
    }

    clear_variable = TH_capture_enemies_count
}

spth_calc_koishi_lingli_upkeep = {
    optimize_memory
    set_variable = { which = koishi_lingli_upkeep value = 0 }
    if = {
        limit = { has_country_flag = enable_koishi_fleet_support_1 }
        change_variable = { which = koishi_lingli_upkeep value = 15 }
    }
    if = {
        limit = { has_country_flag = enable_koishi_fleet_support_2 }
        change_variable = { which = koishi_lingli_upkeep value = 5 }
    }
    if = {
        limit = { has_country_flag = enable_koishi_fleet_support_3 }
        change_variable = { which = koishi_lingli_upkeep value = 20 }
    }
    if = {
        limit = { has_country_flag = enable_koishi_fleet_support_4 }
        change_variable = { which = koishi_lingli_upkeep value = 5 }
    }
    if = {
        limit = { has_country_flag = enable_koishi_fleet_support_5 }
        change_variable = { which = koishi_lingli_upkeep value = 20 }
    }
    if = {
        limit = { has_country_flag = enable_koishi_fleet_support_6 }
        change_variable = { which = koishi_lingli_upkeep value = 15 }
    }
}

koishi_gal_combat_effect_self = {
    optimize_memory
    if = {
        limit = { owner = { has_country_flag = enable_koishi_fleet_support_1 } }
        koishi_gal_combat_effect_1_self = yes
    }
    if = {
        limit = { owner = { has_country_flag = enable_koishi_fleet_support_3 } }
        koishi_gal_combat_effect_3_self = yes
    }
    if = {
        limit = { owner = { has_country_flag = enable_koishi_fleet_support_6 } }
        koishi_gal_combat_effect_6_self = yes
    }
}

# This = our fleet
# From = enemy fleet
# FromFrom = our country
koishi_gal_combat_effect = {
    optimize_memory
    if = {
        limit = { fromfrom = { has_country_flag = enable_koishi_fleet_support_1 } }
        from = { every_owned_ship = { set_ship_flag = debuff_koishi_fleet_support_1 } }
    }
    if = {
        limit = { fromfrom = { has_country_flag = enable_koishi_fleet_support_2 } }
        from = {
            if = {
                limit = { NOT = { has_fleet_flag = koishi_combat_assassin_cooldown } }
                if = {
                    limit = { exists = leader leader = { NOT = { has_leader_flag = spth_sp_leader } } }
                    random_list = {
                        75 = {}
                        25 = {
                            leader = {
                                if = {
                                    limit = { NOT = { has_leader_flag = spth_sp_leader } }
                                    unassign_leader = this
                                    # exile_leader_as = this
                                    kill_leader = { show_notification = no }
                                }
                            }
                        }
                    }
                }
                set_timed_fleet_flag = { flag = koishi_combat_assassin_cooldown days = 5 }
            }
        }
    }
    if = {
        limit = { fromfrom = { has_country_flag = enable_koishi_fleet_support_3 } }
        koishi_gal_combat_effect_3 = yes
    }
    if = {
        limit = { fromfrom = { has_country_flag = enable_koishi_fleet_support_4 } }
        koishi_gal_combat_effect_4 = yes
    }
    if = {
        limit = { fromfrom = { has_country_flag = enable_koishi_fleet_support_5 } }
        koishi_gal_combat_effect_5 = yes
    }
}
koishi_gal_combat_effect_3 = {
    optimize_memory
    # 保证船体提升至少floor(2000000*(60%+(恋恋灵力/1028)))
    set_variable = { which = koishi_ship_hull_var value = owner.spth_koishi_lingli_var }
    divide_variable = { which = koishi_ship_hull_var value = 1028 }
    change_variable = { which = koishi_ship_hull_var value = 0.60 }
    multiply_variable = { which = koishi_ship_hull_var value = 2000000 }
}
koishi_gal_combat_effect_4 = {
    optimize_memory
    if = {
        limit = {
            from = { is_ship_class = shipclass_military }
            NOT = { has_fleet_flag = koishi_support_cooldown }
        }
        set_timed_fleet_flag = { flag = koishi_support_cooldown days = 45 }
        solar_system = {
            create_ambient_object = {
                type = "star_explosion"
                play_animation_once = yes
                location = this.star
            }
            last_created_ambient_object = {
                set_location = { target = this.star distance = 0 angle = random }
            }
        }
        from = {
            set_variable = { which = koishi_ship_count value = 0 }
            export_trigger_value_to_variable = {
                trigger = count_owned_ship
                parameters = { limit = { is_ship_class = shipclass_military is_koishi_original_ships = yes } }
                variable = koishi_ship_count
            }
            random_list = {
                1 = { multiply_variable = { which = koishi_ship_count value = 0.20 } }
                1 = { multiply_variable = { which = koishi_ship_count value = 0.25 } }
                1 = { multiply_variable = { which = koishi_ship_count value = 0.30 } }
                1 = { multiply_variable = { which = koishi_ship_count value = 0.35 } }
                1 = { multiply_variable = { which = koishi_ship_count value = 0.40 } }
                1 = { multiply_variable = { which = koishi_ship_count value = 0.45 } }
                1 = { multiply_variable = { which = koishi_ship_count value = 0.50 } }
            }
            reroll_random = yes
            floor_variable = koishi_ship_count
            if = {
                limit = { check_variable = { which = koishi_ship_count value < 1 } }
                set_variable = { which = koishi_ship_count value = 1 }
            }
            if = {
                limit = {
                    exists = leader
                    leader = { has_trait = leader_trait_koishi }
                }
                while = {
                    count = koishi_ship_count
                    random_owned_ship = {
                        limit = { is_ship_class = shipclass_military }
                        koishi_reduce_hp_percent = { percent = 50 }
                    }
                }
            } else = {
                while = {
                    count = koishi_ship_count
                    random_owned_ship = {
                        limit = { is_ship_class = shipclass_military }
                        koishi_reduce_hp_percent = { percent = 25 }
                    }
                }
            }
        }
    }
}
koishi_gal_combat_effect_5 = {
    optimize_memory
    if = {
        limit = { NOT = { has_fleet_flag = koishi_combat_upgrade_finished } }
        set_fleet_flag = koishi_combat_upgrade_finished
        every_owned_ship = {
            set_variable = { which = koishi_repeatable_rate value = 0.05 }
            set_variable = { which = koishi_repeatable_temp value = owner.spth_koishi_lingli_var }
            divide_variable = { which = koishi_repeatable_temp value = 2056 }
            if = {
                limit = { check_variable = { which = koishi_repeatable_temp value > 0.05 } }
                change_variable = { which = koishi_repeatable_rate value = koishi_repeatable_temp }
            } else = {
                change_variable = { which = koishi_repeatable_rate value = 0.05 }
            }

            set_variable = { which = koishi_repeatable_var value = 0 }
            # energy
            export_modifier_to_variable = {
                modifier = weapon_type_energy_weapon_damage_mult
                variable = koishi_repeatable_var
            }
            if = {
                limit = { check_variable = { which = koishi_repeatable_var value < 0 } }
                multiply_variable = { which = koishi_repeatable_var value = -1 }
            }
            multiply_variable = { which = koishi_repeatable_var value = koishi_repeatable_rate }
            change_variable = { which = koishi_repeatable_var value = 1 }
            add_modifier = { modifier = koishi_improve_energy_damage multiplier = koishi_repeatable_var }
            set_variable = { which = koishi_repeatable_temp value = koishi_repeatable_var }
            # kinetic
            export_modifier_to_variable = {
                modifier = weapon_type_kinetic_weapon_damage_mult
                variable = koishi_repeatable_var
            }
            if = {
                limit = { check_variable = { which = koishi_repeatable_var value < 0 } }
                multiply_variable = { which = koishi_repeatable_var value = -1 }
            }
            multiply_variable = { which = koishi_repeatable_var value = koishi_repeatable_rate }
            change_variable = { which = koishi_repeatable_var value = 1 }
            add_modifier = { modifier = koishi_improve_kinetic_damage multiplier = koishi_repeatable_var }
            if = {
                limit = { check_variable = { which = koishi_repeatable_var value > koishi_repeatable_temp } }
                set_variable = { which = koishi_repeatable_temp value = koishi_repeatable_var }
            }
            # explosive
            export_modifier_to_variable = {
                modifier = weapon_type_explosive_weapon_damage_mult
                variable = koishi_repeatable_var
            }
            if = {
                limit = { check_variable = { which = koishi_repeatable_var value < 0 } }
                multiply_variable = { which = koishi_repeatable_var value = -1 }
            }
            multiply_variable = { which = koishi_repeatable_var value = koishi_repeatable_rate }
            change_variable = { which = koishi_repeatable_var value = 1 }
            add_modifier = { modifier = koishi_improve_explosive_damage multiplier = koishi_repeatable_var }
            if = {
                limit = { check_variable = { which = koishi_repeatable_var value > koishi_repeatable_temp } }
                set_variable = { which = koishi_repeatable_temp value = koishi_repeatable_var }
            }
            # special
            change_variable = { which = koishi_repeatable_var value = 2 }
            add_modifier = { modifier = koishi_improve_special_damage multiplier = koishi_repeatable_var }

            clear_variable = koishi_repeatable_temp
        }
    }
}
koishi_gal_combat_effect_1_self = {
    optimize_memory
    TH_dynamic_modifier_conditional = {
        modifier = "ship_evasion_mult"
        relation = "<"
        limit_value = 1
        value = 1
    }
    TH_dynamic_modifier_conditional = {
        modifier = "ship_evasion_add"
        relation = "<"
        limit_value = 100
        value = 100
    }
}
koishi_gal_combat_effect_1_enemy = {
    optimize_memory
    if = {
        limit = { has_ship_flag = debuff_koishi_fleet_support_1 }
        if = {
            limit = {
                check_variable = { which = koishi_combat_days value <= 4 }
            }
            TH_dynamic_modifier_conditional = {
                modifier = "ship_accuracy_mult"
                relation = ">"
                limit_value = -1
                value = -1
            }
            TH_dynamic_modifier_conditional = {
                modifier = "ship_tracking_mult"
                relation = ">"
                limit_value = -1
                value = -1
            }
        }
        if = {
            limit = { NOT = { has_ship_flag = koishi_combat_1_cooldown } }
            TH_timed_check_modifier = {
                modifier = "ship_accuracy_mult"
                relation = ">"
                check_value = -1
                value = -1
                days = 2
            }
            TH_timed_check_modifier = {
                modifier = "ship_tracking_mult"
                relation = ">"
                check_value = -1
                value = -1
                days = 2
            }
            set_timed_ship_flag = { flag = koishi_combat_1_cooldown days = 8 }
        }
    }
}
koishi_gal_combat_effect_3_self = {
    optimize_memory
    if = {
        limit = { NOT = { has_ship_flag = koishi_combat_defence_cooldown } }
        set_variable = { which = koishi_ship_hull_var value = fleet.koishi_ship_hull_var }
        floor_variable = koishi_ship_hull_var
        # set_update_modifiers_batch = begin
        remove_modifier = koishi_improve_ship_hull
        add_modifier = { modifier = koishi_improve_ship_hull multiplier = koishi_ship_hull_var }
        # set_update_modifiers_batch = end
        repair_ship = yes
        set_timed_ship_flag = { flag = koishi_combat_defence_cooldown days = 3 }
    }
}
koishi_gal_combat_effect_6_self = {
    optimize_memory
    TH_dynamic_modifier_conditional = {
        modifier = "ship_shield_penetration_mult"
        relation = "<"
        limit_value = 0.50
        value = 0.50
    }
    TH_dynamic_modifier_conditional = {
        modifier = "ship_armor_penetration_mult"
        relation = "<"
        limit_value = 0.50
        value = 0.50
    }
}

koishi_reduce_hp_percent = {
    optimize_memory
    set_variable = { which = koishi_hitpoint value = 0 }
    export_trigger_value_to_variable = { trigger = has_hp variable = koishi_hitpoint }
    multiply_variable = { which = koishi_hitpoint value = $percent$ }
    multiply_variable = { which = koishi_hitpoint value = 0.01 }
    floor_variable = koishi_hitpoint
    reduce_hp = koishi_hitpoint
    clear_variable = koishi_hitpoint
}

koishi_reduce_hp_rest = {
    optimize_memory
    set_variable = { which = koishi_hitpoint value = 0 }
    export_trigger_value_to_variable = { trigger = has_hp variable = koishi_hitpoint }
    change_variable = { which = koishi_hitpoint value = $rest$ }
    floor_variable = koishi_hitpoint
    reduce_hp = koishi_hitpoint
    clear_variable = koishi_hitpoint
}

spth_leader_recruit_save_event_target = {
    optimize_memory
    random_owned_leader = {
        limit = { has_leader_flag = spth_sp_leader has_trait = leader_trait_$who$ }
        save_event_target_as = spth_card_portrait_leader
    }
}
