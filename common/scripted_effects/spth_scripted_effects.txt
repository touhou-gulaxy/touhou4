spth_effect_init_container_country_effect = {
    if = {
        limit = { NOT = { exists = event_target:spth_container_country } }
        create_country = {
            name = NAME_spth_leader_country
            type = spth_country_type_container
            flag = {
				colors = {
					"black"
					"black"
					"null"
					"null"
				}
            }
			effect = {
				save_global_event_target_as = spth_container_country
			}
        }
    }
    event_target:spth_container_country = {
        if = {
            limit = { NOT = { exists = event_target:spth_container_species } }
            create_species = {
	    		name = "NAME_Unknown"
	    		class = HUM
	    		portrait = random
	    		namelist = random
	    		traits = {  }
	    		allow_negative_traits = no
	    		effect = { save_global_event_target_as = spth_container_species }
	    	}
        }
    }
}

spth_debug_trigger_lunar_capital_ruin = {
	optimize_memory
	if = {
		limit = { is_scope_type = country }
		country_event = {
			id = toho.3000
			scopes = {
				from = event_target:spth_story_sol_system_earth
				fromfrom = event_target:spth_story_sol_system_lunar_capital
			}
		}
	}
}

# special project completed effects
# This - ship conducted the project
# From - Project creation location
spth_special_project_research_moon_barrier = {
	optimize_memory
	root.owner = {
		if = {
			limit = { check_variable = { which = spth_research_moon_barrier_var value >= 160 } }
			create_message = {
				type = spth_finish_special_project
				localization = spth_message_finish_special_project_desc
				variable = {
					type = name
					localization = SPTH_LEADER_NAME
					scope = root.leader
				}
				variable = {
					type = key
					value = spth_research_moon_barrier
					localization = SPTH_PROJECT_NAME
				}
				target = root.leader
				recipient = this
				days = 32
			}
			country_event = { id = toho.3001 }
			clear_variable = spth_research_moon_barrier_var
		} else = {
			set_variable = { which = spth_research_moon_barrier_max value = 160 }
			create_message = {
				type = spth_finish_progress_special_project
				localization = spth_message_finish_progress_special_project_desc
				variable = {
					type = name
					localization = SPTH_LEADER_NAME
					scope = root.leader
				}
				variable = {
					type = key
					value = spth_research_moon_barrier
					localization = SPTH_PROJECT_NAME
				}
				variable = {
					type = variable
					varname = spth_research_moon_barrier_var
					localization = SPTH_PROGRESS
					scope = this
				}
				variable = {
					type = variable
					varname = spth_research_moon_barrier_max
					localization = SPTH_TOTAL_PROGRESS
					scope = this
				}
				target = root.leader
				recipient = this
				days = 32
			}
			clear_variable = spth_research_moon_barrier_max
			enable_special_project = {
				name = spth_research_moon_barrier
				location = event_target:spth_story_sol_system_lunar_capital
				owner = this
			}
			root.fleet = {
				fleet_action_research_special_project = {
					special_project = spth_research_moon_barrier
					target = event_target:spth_story_sol_system_lunar_capital
				}
			}
		}
	}
}
spth_special_project_torifune_shield = {
	optimize_memory
	root.owner = {
		# 60%几率失败，但最后一个方案必定成功
		change_variable = { which = spth_disable_habitat_shield_retry value = 1 }
		random_list = {
			60 = {
				modifier = {
					mult = 0
					check_variable = {
						which = spth_disable_habitat_shield_retry
						value >= spth_disable_habitat_shield_count
					}
				}
				create_message = {
					type = spth_finish_progress_special_project
					localization = spth_message_finish_progress_special_project_desc_1
					variable = {
						type = name
						localization = SPTH_SHIP_NAME
						scope = root
					}
					variable = {
						type = variable
						varname = spth_disable_habitat_shield_retry
						localization = SPTH_RETRY_TIMES
						scope = this
					}
					variable = {
						type = key
						value = spth_disable_habitat_shield_2
						localization = SPTH_PROJECT_NAME
					}
					variable = {
						type = variable
						varname = spth_disable_habitat_shield_count
						localization = SPTH_TOTAL_COUNT
						scope = this
					}
					target = this
					recipient = this
					days = 30
				}
				enable_special_project = {
					name = spth_disable_habitat_shield_2
					location = root.from
					owner = root.owner
				}
			}
			40 = {
				create_message = {
					type = spth_finish_special_project
					localization = spth_message_finish_special_project_desc_1
					variable = {
						type = key
						value = spth_disable_habitat_shield_2
						localization = SPTH_PROJECT_NAME
					}
					target = root.from
					recipient = this
					days = 30
				}
				country_event = { id = toho.3007 }
			}
		}
	}
}

# unlock the super carrier ship design
spth_unlock_super_carrier = {
	optimize_memory
	# [[flag] set_country_flag = can_build_spth_super_carrier]
	# [[reset]
	# 	remove_global_ship_design = NAME_spth_super_carrier_basic
	# 	add_global_ship_design = NAME_spth_super_carrier_basic
	# 	random_owned_ship = {
	# 		limit = { is_ship_size = TH_super_carrier }
	# 		set_ship_design = { design = NAME_spth_super_carrier_basic }
	# 		prev = { remove_ship_design = prev.design }
	# 	}
	# ]
	if = {
		limit = { NOT = { has_existing_ship_design = TH_super_carrier } }
		create_ship_design = { design = NAME_spth_super_carrier_basic }
		add_ship_design = last_created_design
	}
}

spth_spawn_kedama_country = {
	optimize_memory
	if = {
		limit = { NOT = { exists = event_target:kedama_country } }
		create_country = {
			name = NAME_spth_kedama_country
			type = kedama
			flag = {
				icon = {
					category = "zoological"
					file = "flag_zoological_1.dds"
				}
				background= {
					category = "backgrounds"
					file = "00_solid.dds"
				}
				colors={
					"red"
					"red"
					"null"
					"null"
				}
			}
			effect = {
				save_global_event_target_as = kedama_country
			}
		}
	}
}
spth_spawn_kedama_fleet = {
	optimize_memory
	create_fleet = {
		name = $NAME$
		settings = {
			can_change_composition = $can_change_composition|yes$
			uses_naval_capacity = $uses_naval_capacity|no$
			spawn_debris = $spawn_debris|no$
			can_disband = $can_disband$
			is_boss = $is_boss$
		}
		effect = {
			set_owner = $OWNER$
			[[bombardment] set_fleet_bombardment_stance = $bombardment$ ]
			[[flag] set_fleet_flag = $flag$ ]
			[[spth_kedama_small_common] while = { count = $spth_kedama_small_common$ } create_ship = { name = random design = NAME_spth_kedama_small_common } ]
			[[spth_kedama_small_common_sp] while = { count = $spth_kedama_small_common_sp$ } create_ship = { name = random design = NAME_spth_kedama_small_common_sp } ]
			[[spth_kedama_small_rare] while = { count = $spth_kedama_small_rare$ } create_ship = { name = random design = NAME_spth_kedama_small_rare } ]
			[[spth_kedama_small_rare_sp] while = { count = $spth_kedama_small_rare_sp$ } create_ship = { name = random design = NAME_spth_kedama_small_rare_sp } ]
			[[spth_kedama_small_titan] while = { count = $spth_kedama_small_titan$ } create_ship = { name = random design = NAME_spth_kedama_small_titan } ]
			set_location = $location$
		}
	}
}

spth_roll_card_techs = {
	optimize_memory
	change_variable = { which = spth_card_current_tech value = 1 }
	random_list = {
		10 = {
			modifier = {
				factor = 0
				has_technology = tech_th_engine_xijian
			}
			give_technology = { tech = "tech_th_engine_xijian" }
		}
		10 = {
			modifier = {
				factor = 0
				has_technology = tech_th_ship_part_taiyang
			}
			give_technology = { tech = "tech_th_ship_part_taiyang" }
		}
		10 = {
			modifier = {
				factor = 0
				has_technology = tech_th_weapon_gungnir
			}
			give_technology = { tech = "tech_th_weapon_gungnir" }
		}
		1 = {
			modifier = {
				factor = 0
				has_technology = tech_th_weapon_yuzhu
			}
			give_technology = { tech = "tech_th_weapon_yuzhu" }
		}
		10 = {
			modifier = {
				factor = 0
				has_technology = tech_spth_moon_computer
			}
			give_technology = { tech = "tech_spth_moon_computer" }
		}
	}
}
spth_roll_advanced_techs = {
	optimize_memory
	add_resource = { sr_lingli = $cost$ }
	random_list = {
		$failed_factor$ = {}
		$success_factor$ = { set_country_flag = spth_advanced_tech_get }
	}
	reroll_random = yes
	if = {
		limit = { has_country_flag = spth_advanced_tech_get }
		remove_country_flag = spth_advanced_tech_get
		change_variable = { which = spth_advanced_techs_count value = 1 }
		random_list = {
			1 = {
				modifier = {
					factor = 0
					has_technology = tech_spth_weapon_laevatain
				}
				give_technology = { tech = tech_spth_weapon_laevatain }
			}
			1 = {
				modifier = {
					factor = 0
					has_technology = tech_spth_hv_bombardment
				}
				give_technology = { tech = tech_spth_hv_bombardment }
			}
			1 = {
				modifier = {
					factor = 0
					has_technology = tech_spth_super_carrier_theory
				}
				give_technology = { tech = tech_spth_super_carrier_theory }
			}
		}
	}
}

scarlet_weather_storm_add = {
	optimize_memory
	scarlet_weather_$type$_storm_add = yes
}
scarlet_weather_storm_remove = {
	optimize_memory
	scarlet_weather_$type$_storm_remove = yes
}
scarlet_weather_reimu_storm_add = {
	optimize_memory
	set_star_flag = storm_system
	set_global_flag = cosmic_storm_has_occurred

	inline_script = {
		script = "cosmic_storms/StormVisuals"
		STORM_NAME = "gravity_storm"
	}
	if = {
		limit = {
			has_owner = yes
		}
		owner = {
			set_country_flag = affected_by_scarlet_weather_reimu_storm
		}
	}
}
scarlet_weather_reimu_storm_remove = {
	optimize_memory
	remove_storm_visuals_effect = yes
	remove_star_flag = storm_system
	if = {
		limit = {
			has_owner = yes
		}
		owner = {
			remove_country_flag = affected_by_scarlet_weather_reimu_storm
		}
	}
}

scarlet_weather_system_selector = {
	optimize_memory
	start_storm_area_placing = {
		sacrifice_leader_with_ui = yes
		cosmic_storm = scarlet_weather_$type$_storm
		immediate = yes
		reticle_radius = {
			base = 100
		}
		max_range = {
			base = 1500
		}
		on_confirm = {
			last_created_cosmic_storm = { set_storm_flag = scarlet_weather_$type$_man_made_@root }
		}
		on_cancel = {

		}
	}
}
scarlet_weather_break = {
	optimize_memory
	every_cosmic_storm = {
		limit = {
			has_storm_flag = scarlet_weather_$type$_man_made_@root
		}
		destroy_cosmic_storm = yes
	}
}
spth_very_COOOOLL_system_selector = {
	optimize_memory
	start_storm_area_placing = {
		sacrifice_leader_with_ui = no # yes则弹出窗口选择要牺牲的领袖
		cosmic_storm = example_selector_storm # 风暴类型
		immediate = yes
		reticle_radius = {
			base = 10
		}
		max_range = {
			base = 1000 # 大圈选择范围
		}
		on_confirm = { # 国家域
			last_created_cosmic_storm = {
				every_system_within_storm = {
					# 在这里写范围内星系效果
					destroy_star_system = yes
				}
				destroy_cosmic_storm = yes
			}
		}
		on_cancel = { # 国家域
			# 取消选择的效果
		}
	}
}
