spth_effect_init_container_country_effect = {
    if = {
        limit = { NOT = { exists = event_target:spth_container_country } }
        create_country = {
            name = NAME_spth_leader_country
            type = spth_country_type_container
            flag = {
				colors = {
					"black"
					"black"
					"null"
					"null"
				}
				background = {
					category = "backgrounds"
					file = "00_solid.dds"
				}
            }
			effect = {
				save_global_event_target_as = spth_container_country
			}
        }
    }
    event_target:spth_container_country = {
        if = {
            limit = { NOT = { exists = event_target:spth_container_species } }
            create_species = {
	    		name = "NAME_Unknown"
	    		class = HUM
	    		portrait = random
	    		namelist = random
	    		traits = {  }
	    		allow_negative_traits = no
	    		effect = { save_global_event_target_as = spth_container_species }
	    	}
        }
    }
}

spth_debug_trigger_lunar_capital_ruin = {
	optimize_memory
	if = {
		limit = { is_scope_type = country }
		country_event = {
			id = toho.3000
			scopes = {
				from = event_target:spth_story_sol_system_earth
				fromfrom = event_target:spth_story_sol_system_lunar_capital
			}
		}
	}
}

# special project completed effects
# This - ship conducted the project
# From - Project creation location
spth_special_project_research_moon_barrier = {
	optimize_memory
	root.owner = {
		if = {
			limit = { check_variable = { which = spth_research_moon_barrier_var value >= 160 } }
			create_message = {
				type = spth_finish_special_project
				localization = spth_message_finish_special_project_desc
				variable = {
					type = name
					localization = SPTH_LEADER_NAME
					scope = root.leader
				}
				variable = {
					type = key
					value = spth_research_moon_barrier
					localization = SPTH_PROJECT_NAME
				}
				target = root.leader
				recipient = this
				days = 32
			}
			country_event = { id = toho.3001 }
			clear_variable = spth_research_moon_barrier_var
		} else = {
			set_variable = { which = spth_research_moon_barrier_max value = 160 }
			create_message = {
				type = spth_finish_progress_special_project
				localization = spth_message_finish_progress_special_project_desc
				variable = {
					type = name
					localization = SPTH_LEADER_NAME
					scope = root.leader
				}
				variable = {
					type = key
					value = spth_research_moon_barrier
					localization = SPTH_PROJECT_NAME
				}
				variable = {
					type = variable
					varname = spth_research_moon_barrier_var
					localization = SPTH_PROGRESS
					scope = this
				}
				variable = {
					type = variable
					varname = spth_research_moon_barrier_max
					localization = SPTH_TOTAL_PROGRESS
					scope = this
				}
				target = root.leader
				recipient = this
				days = 32
			}
			clear_variable = spth_research_moon_barrier_max
			enable_special_project = {
				name = spth_research_moon_barrier
				location = event_target:spth_story_sol_system_lunar_capital
				owner = this
			}
			root.fleet = {
				fleet_action_research_special_project = {
					special_project = spth_research_moon_barrier
					target = event_target:spth_story_sol_system_lunar_capital
				}
			}
		}
	}
}
spth_special_project_torifune_shield = {
	optimize_memory
	root.owner = {
		# 60%几率失败，但最后一个方案必定成功
		change_variable = { which = spth_disable_habitat_shield_retry value = 1 }
		random_list = {
			60 = {
				modifier = {
					mult = 0
					check_variable = {
						which = spth_disable_habitat_shield_retry
						value >= spth_disable_habitat_shield_count
					}
				}
				create_message = {
					type = spth_finish_progress_special_project
					localization = spth_message_finish_progress_special_project_desc_1
					variable = {
						type = name
						localization = SPTH_SHIP_NAME
						scope = root
					}
					variable = {
						type = variable
						varname = spth_disable_habitat_shield_retry
						localization = SPTH_RETRY_TIMES
						scope = this
					}
					variable = {
						type = key
						value = spth_disable_habitat_shield_2
						localization = SPTH_PROJECT_NAME
					}
					variable = {
						type = variable
						varname = spth_disable_habitat_shield_count
						localization = SPTH_TOTAL_COUNT
						scope = this
					}
					target = this
					recipient = this
					days = 30
				}
				enable_special_project = {
					name = spth_disable_habitat_shield_2
					location = root.from
					owner = root.owner
				}
			}
			40 = {
				create_message = {
					type = spth_finish_special_project
					localization = spth_message_finish_special_project_desc_1
					variable = {
						type = key
						value = spth_disable_habitat_shield_2
						localization = SPTH_PROJECT_NAME
					}
					target = root.from
					recipient = this
					days = 30
				}
				country_event = { id = toho.3007 }
			}
		}
	}
}

# unlock the super carrier ship design
spth_unlock_super_carrier = {
	optimize_memory
	# [[flag] set_country_flag = can_build_spth_super_carrier]
	# [[reset]
	# 	remove_global_ship_design = NAME_spth_super_carrier_basic
	# 	add_global_ship_design = NAME_spth_super_carrier_basic
	# 	random_owned_ship = {
	# 		limit = { is_ship_size = TH_super_carrier }
	# 		set_ship_design = { design = NAME_spth_super_carrier_basic }
	# 		prev = { remove_ship_design = prev.design }
	# 	}
	# ]
	if = {
		limit = { NOT = { has_existing_ship_design = TH_super_carrier } }
		create_ship_design = { design = NAME_spth_super_carrier_basic }
		add_ship_design = last_created_design
	}
}

spth_spawn_kedama_country = {
	optimize_memory
	if = {
		limit = { NOT = { exists = event_target:kedama_country } }
		create_country = {
			name = NAME_spth_kedama_country
			type = kedama
			flag = {
				icon = {
					category = "zoological"
					file = "flag_zoological_1.dds"
				}
				background= {
					category = "backgrounds"
					file = "00_solid.dds"
				}
				colors={
					"red"
					"red"
					"null"
					"null"
				}
			}
			effect = {
				save_global_event_target_as = kedama_country
			}
		}
	}
}
spth_spawn_kedama_fleet = {
	optimize_memory
	create_fleet = {
		name = $NAME$
		settings = {
			can_change_composition = $can_change_composition|yes$
			uses_naval_capacity = $uses_naval_capacity|no$
			spawn_debris = $spawn_debris|no$
			can_disband = $can_disband$
			is_boss = $is_boss$
		}
		effect = {
			set_owner = $OWNER$
			[[bombardment] set_fleet_bombardment_stance = $bombardment$ ]
			[[flag] set_fleet_flag = $flag$ ]
			[[spth_kedama_small_common] while = { count = $spth_kedama_small_common$ } create_ship = { name = random design = NAME_spth_kedama_small_common } ]
			[[spth_kedama_small_common_sp] while = { count = $spth_kedama_small_common_sp$ } create_ship = { name = random design = NAME_spth_kedama_small_common_sp } ]
			[[spth_kedama_small_rare] while = { count = $spth_kedama_small_rare$ } create_ship = { name = random design = NAME_spth_kedama_small_rare } ]
			[[spth_kedama_small_rare_sp] while = { count = $spth_kedama_small_rare_sp$ } create_ship = { name = random design = NAME_spth_kedama_small_rare_sp } ]
			[[spth_kedama_small_titan] while = { count = $spth_kedama_small_titan$ } create_ship = { name = random design = NAME_spth_kedama_small_titan } ]
			set_location = $location$
		}
	}
}
spth_create_fleet = {
	optimize_memory
	create_fleet = {
		name = $NAME$
		settings = {
			can_change_composition = $can_change_composition|yes$
			uses_naval_capacity = $uses_naval_capacity|no$
			spawn_debris = $spawn_debris|no$
			can_disband = $can_disband$
			is_boss = $is_boss$
		}
		effect = {
			set_owner = $OWNER$
			set_location = { target = $location$ distance = $distance|25$ angle = random }
			[[bombardment] set_fleet_bombardment_stance = $bombardment$ ]
			[[flag] set_fleet_flag = $flag$ ]

			# kedama ships
			[[spth_kedama_small_common] while = { count = $spth_kedama_small_common$ } create_ship = { name = random design = NAME_spth_kedama_small_common } ]
			[[spth_kedama_small_common_sp] while = { count = $spth_kedama_small_common_sp$ } create_ship = { name = random design = NAME_spth_kedama_small_common_sp } ]
			[[spth_kedama_small_rare] while = { count = $spth_kedama_small_rare$ } create_ship = { name = random design = NAME_spth_kedama_small_rare } ]
			[[spth_kedama_small_rare_sp] while = { count = $spth_kedama_small_rare_sp$ } create_ship = { name = random design = NAME_spth_kedama_small_rare_sp } ]
			[[spth_kedama_small_titan] while = { count = $spth_kedama_small_titan$ } create_ship = { name = random design = NAME_spth_kedama_small_titan } ]

			# enclave ships
			[[spth_curator_defence_bc_tor] while = { count = $spth_curator_defence_bc_tor$ create_ship = { name = random design = spth_curator_defence_bc_tor } } ]
			[[spth_curator_defence_bc_tlx] while = { count = $spth_curator_defence_bc_tlx$ create_ship = { name = random design = spth_curator_defence_bc_tlx } } ]
			[[spth_curator_defence_bc_tmp] while = { count = $spth_curator_defence_bc_tmp$ create_ship = { name = random design = spth_curator_defence_bc_tmp } } ]
			[[spth_curator_defence_bc_ylx] while = { count = $spth_curator_defence_bc_ylx$ create_ship = { name = random design = spth_curator_defence_bc_ylx } } ]
			[[spth_curator_defence_cr] while = { count = $spth_curator_defence_cr$ create_ship = { name = random design = spth_curator_defence_cr graphical_culture = strg_01 } } ]
			[[spth_curator_defence_co] while = { count = $spth_curator_defence_co$ create_ship = { name = random design = spth_curator_defence_co graphical_culture = strg_01 } } ]

			[[fleet_action] fleet_event = { id = $fleet_action$ } ]
			[[fleet_action_delayed] fleet_event = { id = $fleet_action_delayed$ days = $DAYS$ random = $DAYS_RANDOM$ } ]
			[[modifier] add_modifier = { modifier = $modifier$ mult = $MUL$ days = $DURATION$ } ]
			[[evt_target] save_event_target_as = $evt_target$ ]
		}
	}
}
# this = country
# curator: spth_spawn_enclave_system = { type = curator }
spth_spawn_enclave_system = {
	optimize_memory
	if = {
		limit = { NOT = { has_global_flag = created_spth_enclave_$type$ } }
		capital_scope.solar_system = {
			set_spawn_system_batch = begin
			spawn_system = {
				initializer = spth_enclave_$type$_system
				hyperlane = yes
				min_distance >= 20
				max_distance <= 50
				max_jumps = 3
			}
			set_spawn_system_batch = end
		}
	}
}

spth_roll_card_techs = {
	optimize_memory
	change_variable = { which = spth_card_current_tech value = 1 }
	random_list = {
		10 = {
			modifier = {
				factor = 0
				has_technology = tech_th_engine_xijian
			}
			give_technology = { tech = "tech_th_engine_xijian" }
		}
		10 = {
			modifier = {
				factor = 0
				has_technology = tech_th_ship_part_taiyang
			}
			give_technology = { tech = "tech_th_ship_part_taiyang" }
		}
		10 = {
			modifier = {
				factor = 0
				has_technology = tech_th_weapon_gungnir
			}
			give_technology = { tech = "tech_th_weapon_gungnir" }
		}
		1 = {
			modifier = {
				factor = 0
				has_technology = tech_th_weapon_yuzhu
			}
			give_technology = { tech = "tech_th_weapon_yuzhu" }
		}
		10 = {
			modifier = {
				factor = 0
				has_technology = tech_spth_moon_computer
			}
			give_technology = { tech = "tech_spth_moon_computer" }
		}
	}
	create_message = {
		type = spth_roll_tech_success
		localization = spth_message_spth_roll_tech_success_desc
		days = 30
		target = this
		recipient = this
	}
}
spth_roll_advanced_techs = {
	optimize_memory
	add_resource = { sr_lingli = $cost$ }
	random_list = {
		$failed_factor$ = {}
		$success_factor$ = { set_country_flag = spth_advanced_tech_get }
	}
	reroll_random = yes
	if = {
		limit = { has_country_flag = spth_advanced_tech_get }
		remove_country_flag = spth_advanced_tech_get
		change_variable = { which = spth_advanced_techs_count value = 1 }
		random_list = {
			1 = {
				modifier = {
					factor = 0
					has_technology = tech_spth_weapon_laevatain
				}
				give_technology = { tech = tech_spth_weapon_laevatain }
			}
			1 = {
				modifier = {
					factor = 0
					has_technology = tech_spth_hv_bombardment
				}
				give_technology = { tech = tech_spth_hv_bombardment }
			}
			1 = {
				modifier = {
					factor = 0
					has_technology = tech_spth_super_carrier_theory
				}
				give_technology = { tech = tech_spth_super_carrier_theory }
			}
		}
		create_message = {
			type = spth_roll_tech_success
			localization = spth_message_spth_roll_tech_success_desc
			days = 30
			target = this
			recipient = this
		}
	} else = {
		create_message = {
			type = spth_roll_tech_failed
			localization = spth_message_spth_roll_tech_failed_desc
			days = 30
			target = this
			recipient = this
		}
	}
}

spth_add_starbase_buildings = {
	optimize_memory
	if = {
		limit = { NOT = { has_starbase_building = $building$ } }
		set_starbase_building = { slot = $slot$ building = $building$ }
	}
}
spth_create_player_space_shrine = {
	optimize_memory
	create_fleet = {
		name = NAME_spth_space_shrine_station_fleet
		settings = { spawn_debris = no uses_naval_capacity = no }
		effect = {
			set_owner = $OWNER$
			create_ship = {
				design = NAME_spth_space_shrine_station
				prefix = yes
				effect = {
					if = {
						limit = {
							OR = {
								has_global_flag = install_kuat_mod
								has_global_flag = has_ancient_empire_mod
							}
						}
						set_ship_flag = has_ag_flagship
					}
					set_ship_flag = is_spth_space_shrine_station
					set_ship_flag = player_space_shrine_station
					set_name = NAME_spth_space_shrine_station_fleet
					set_disable_at_health = 0.01
					if = {
						limit = { exists = event_target:player_space_shrine_@$OWNER$ }
						event_target:player_space_shrine_@$OWNER$ = {
							delete_ship = this
							delete_fleet = {
								destroy_template = yes
								target = this.fleet
							}
						}
						clear_global_event_target = player_space_shrine_@$OWNER$
					}
					save_global_event_target_as = player_space_shrine_@$OWNER$
					starbase = { set_ship_construction_type = starbase_shipyard }
					ship_event = { id = spth_fleet.200 days = 1 }
				}
			}
			set_fleet_flag = is_spth_space_shrine_station
			set_fleet_flag = player_space_shrine_station
			set_location = { target = $LOCATION$ angle = random distance = -10 }
		}
	}
	$OWNER$ = {
		every_owned_ship = {
			limit = {
				is_ship_size = spth_space_shrine_station
				has_ship_flag = is_spth_space_shrine_station
				starbase = { has_starbase_building = space_shrine_yard }
			}
			starbase = {
				spth_add_starbase_buildings = { slot = 1 building = titan_yards }
				spth_add_starbase_buildings = { slot = 2 building = colossus_yards }
				spth_add_starbase_buildings = { slot = 3 building = toho_yards }
				spth_add_starbase_buildings = { slot = 4 building = space_shrine_yard }
			}
		}
	}
}

spth_concept_query_select = {
	optimize_memory
	hidden_effect = {
		[[room]
			event_target:spth_concept_display_page = {
				room_name_override = $room$
			}
		]
		spth_clear_concept_query_flags = yes
		set_country_flag = spth_queried_concept_$id$
	}
}
spth_clear_concept_query_flags = {
	optimize_memory
	remove_country_flag = spth_queried_concept_a
	remove_country_flag = spth_queried_concept_b
	remove_country_flag = spth_queried_concept_c
	remove_country_flag = spth_queried_concept_d
	remove_country_flag = spth_queried_concept_e
	remove_country_flag = spth_queried_concept_f
	remove_country_flag = spth_queried_concept_g
	remove_country_flag = spth_queried_concept_h
	remove_country_flag = spth_queried_concept_i
	remove_country_flag = spth_queried_concept_j
	remove_country_flag = spth_queried_concept_k
	remove_country_flag = spth_queried_concept_l
	remove_country_flag = spth_queried_concept_m
	remove_country_flag = spth_queried_concept_n
	remove_country_flag = spth_queried_concept_o
	remove_country_flag = spth_queried_concept_p
	remove_country_flag = spth_queried_concept_q
	remove_country_flag = spth_queried_concept_r
	remove_country_flag = spth_queried_concept_s
	remove_country_flag = spth_queried_concept_t
	remove_country_flag = spth_queried_concept_u
	remove_country_flag = spth_queried_concept_v
	remove_country_flag = spth_queried_concept_w
	remove_country_flag = spth_queried_concept_x
	remove_country_flag = spth_queried_concept_y
	remove_country_flag = spth_queried_concept_z
}
